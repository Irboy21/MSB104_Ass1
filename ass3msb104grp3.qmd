---
title: "Assignment 3 — MSB104 — Group 3"
author: "Irjan & Magnus"
format:
  html: default
  pdf: default
execute:
  echo: false
  warning: false
  message: false
---

```{r, include=FALSE}
library(modelr)
library(dplyr)
library(ggplot2)
library(tidyverse)
library(vtable)
library(flextable)
library(scales)
library(tinytex)
library(readxl)
library(stringr)
library(janitor)
library(tidyr)
library(dineq) 
library(knitr)
library(ggrepel)
library(modelsummary)
library(broom)
```

```{r}
NUTS2_data <- readRDS("data/NUTS2_data.rds")
```

```{r}
# Beregn BNP per innbygger-vekst for NUTS2
Vekst_data <- NUTS2_data %>%
  arrange(nuts2, aar) %>%
  group_by(nuts2) %>%
  mutate(vekst = (BNPPINUTS2 - lag(BNPPINUTS2)) / lag(BNPPINUTS2)) %>%
  filter(aar == 2017) %>%
  select(nuts2, vekst, gini)
```

```{r}
library(eurostat)
library(dplyr)

# Henter datasettet fra eurostat
edu_raw <- get_eurostat("edat_lfse_04", time_format = "num") 

#Filtrerer bort det vi ikke trenger 
edu_data <- edu_raw %>%
  filter(age == "Y25-64",
         sex == "T",
         TIME_PERIOD == "2017",
         isced11 %in% c("ED0-2", "ED3_4", "ED5-8")) %>% 
  mutate(nuts2 = geo,
         hoyere_utdanning = values,
         land = substr(nuts2, 1, 2)) %>%
  select(nuts2, hoyere_utdanning, isced11, land,) %>%
   filter(nchar(nuts2) == 4) 

# Filtrerer slik at vi kunn får de landene vi trenger
valgte_land <- c("IT", "RO", "LT", "FI")

edu <- edu_data %>%
  filter(substr(nuts2, 1, 2) %in% valgte_land)

# Setter opp utdanningsnivået som kolonner 

edu_clean <- edu %>%
  select(nuts2, isced11, hoyere_utdanning) %>%
  mutate(isced11 = gsub("-", "_", isced11)) %>%  # ED0-2 → ED0_2
  tidyr::pivot_wider(
    names_from = isced11,
    values_from = hoyere_utdanning
  )

# Beregn BNP per innbygger-vekst for NUTS2
Vekst_data <- NUTS2_data %>%
  arrange(nuts2, aar) %>%
  group_by(nuts2) %>%
  mutate(vekst = (BNPPINUTS2 - lag(BNPPINUTS2)) / lag(BNPPINUTS2)) %>%
  filter(aar == 2017, !gini == 0, !is.na(gini)) %>%
  select(nuts2, vekst, gini)

# slår sammen alt

edu_merged <- Vekst_data %>%
  left_join(edu_clean, by = "nuts2")

```

```{r}
# deler inn utdanningsnivået i tre grupper

edu_merged <- edu_merged %>%
  mutate(
    edu_group = case_when(
      ED0_2 > ED3_4 & ED0_2 > ED5_8 ~ "low_edu",
      ED3_4 > ED0_2 & ED3_4 > ED5_8 ~ "mid_edu",
      ED5_8 > ED0_2 & ED5_8 > ED3_4 ~ "high_edu",
      TRUE ~ NA_character_
    )
  ) %>%
  filter(!is.na(edu_group))
```

For alle regionene som ble definert som høy utdannings, så var gini = 0, noe som vil "ødelegge" resultatet og gi feile svar.

```{r}
mod_low <- lm(gini ~ vekst, data = edu_merged %>% filter(edu_group == "low_edu"))

mod_mid <- lm(gini ~ vekst, data = edu_merged %>% filter(edu_group == "mid_edu"))

modelsummary(
  list(
    "Low education" = mod_low,
    "Mid education" = mod_mid
  ),
  stars = TRUE,
  gof_omit = "IC|Log"
)

```

```{r}
mod_interaction <- lm(gini ~ vekst * edu_group, data = edu_merged)
summary(mod_interaction)

```

For å undersøke om effekten av økonomisk vekst på regional ulikhet varierer med utdanningsnivå, estimerer vi en interaksjonsmodell der middels utdanningsnivå sammenlignes med lav utdanning (referansegruppe).
Interaksjonsleddet måler hvorvidt sammenhengen mellom vekst og ulikhet endrer seg mellom gruppene.

Interaksjonskoeffisienten er positiv (7.55), noe som indikerer at regioner med middels utdanning har en mer positiv vekst–ulikhet-sammenheng enn regioner med lav utdanning.
Effekten er imidlertid ikke statistisk signifikant (p = 0.463), og vi kan derfor ikke konkludere med at forskjellen mellom gruppene er reell.

Innen lav utdanningsgruppe er vekst-effekten negativ, men også klart ikke-signifikant (–6.99, p = 0.496).
For regioner med middels utdanning er den kombinerte vekst-effekten svak positiv (≈0.56), men heller ikke signifikant.
Samlet sett antyder resultatene at det kan eksistere kvalitative forskjeller mellom gruppene, men datasettet for 2017 gir ikke tilstrekkelig statistisk grunnlag til å si at utdanningsnivå modererer forholdet mellom økonomisk vekst og ulikhet.

```{r}
Fordelt_Arbeidsledighet <- Arbeidsledighet %>%
  mutate(
    arbeidsledighet = as.numeric(arbeidsledighet)   
  ) %>%
  filter(!is.na(arbeidsledighet)) %>%               
  mutate(
    Arb_tertile = ntile(arbeidsledighet, 3),
    Arb_group = case_when(
      Arb_tertile == 1 ~ "low",
      Arb_tertile == 2 ~ "mid",
      Arb_tertile == 3 ~ "high"
    ),
    Arb_group = factor(Arb_group, levels = c("low", "mid", "high"))
  )
```

```{r}
Sammenstilt_Arbeidsledighet <- Sammenstilt %>%
  left_join(Fordelt_Arbeidsledighet %>% select(nuts2, Arb_group), by = "nuts2") %>%
  filter(!is.na(Arb_group))  # bare regioner med arbeidsledighetsgruppe
```

```{r}
resultater <- Sammenstilt_Arbeidsledighet %>%
  group_by(Arb_group) %>%
  do({
    mod <- lm(gini ~ vekst, data = .)
    tidy(mod)
  }) %>%
  filter(term == "vekst") %>%
  select(Arb_group, estimate, std.error, statistic, p.value) %>%
  mutate(
    estimate = round(estimate, 4),
    std.error = round(std.error, 4),
    statistic = round(statistic, 4),
    p.value = round(p.value, 4),
    Significance = case_when(
      p.value < 0.001 ~ "***",
      p.value < 0.01  ~ "**",
      p.value < 0.05  ~ "*",
      p.value < 0.1   ~ ".",
      TRUE            ~ ""
    )
  )

# Presenter resultatene som tabell
kable(
  resultater,
  col.names = c("Arbeidsledighet", "Estimert koeffisient", "Standardfeil", "t-verdi", "p-verdi", "Signifikans"),
  caption = "Effekt av vekst på ulikhet (Gini) innen arbeidsledighetsgrupper"
) %>%
  kable_styling(full_width = FALSE)

# Estimer interaksjonsmodell for å teste om effektene er signifikant forskjellige
model_interaction <- lm(gini ~ vekst * Arb_group, data = Sammenstilt_Arbeidsledighet)
summary(model_interaction)
```

```{r}
# Lag tertiler for befolkningstetthet
Fordelt_Befolkning <- Befolkningstethet %>%
  mutate(
    bpk = as.numeric(bpk)  # Gjør om til numerisk hvis nødvendig
  ) %>%
  filter(!is.na(bpk)) %>%
  mutate(
    Bpk_tertile = ntile(bpk, 3),
    Bpk_group = case_when(
      Bpk_tertile == 1 ~ "low",
      Bpk_tertile == 2 ~ "mid",
      Bpk_tertile == 3 ~ "high"
    ),
    Bpk_group = factor(Bpk_group, levels = c("low", "mid", "high"))
  )
```

```{r}
# Slå sammen med resten av datasettet (hvis ikke allerede gjort)
Sammenstilt_Befolkning <- Sammenstilt %>%
  left_join(Fordelt_Befolkning %>% select(nuts2, Bpk_group), by = c("nuts2"))
```

```{r}
# Kjør regresjonsmodell med interaksjon
model_befolkning <- lm(gini ~ vekst * Bpk_group, data = Sammenstilt_Befolkning)

# Sjekk resultater
summary(model_befolkning)
```
