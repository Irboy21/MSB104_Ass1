---
title: "Assignment 3 — MSB104 — Group 3"
author: "Irjan & Magnus"
format:
  html: default
  pdf: default
execute:
  echo: false
  warning: false
  message: false
---

```{r, include=FALSE}
library(modelr)
library(dplyr)
library(ggplot2)
library(tidyverse)
library(vtable)
library(flextable)
library(scales)
library(tinytex)
library(readxl)
library(stringr)
library(janitor)
library(tidyr)
library(dineq) 
library(knitr)
library(ggrepel)
library(modelsummary)
library(broom)
library(eurostat)
library(fixest)

```

```{r}
NUTS2_data <- readRDS("data/NUTS2_data.rds")
```

```{r}
# Beregn BNP per innbygger-vekst for NUTS2
Vekst_data <- NUTS2_data %>%
  arrange(nuts2, aar) %>%
  group_by(nuts2) %>%
  mutate(vekst = (BNPPINUTS2 - lag(BNPPINUTS2)) / lag(BNPPINUTS2)) %>%
  filter(aar == 2017) %>%
  select(nuts2, vekst, gini)
```

## Undergruppe analyse: Utdanningsnivå

```{r}
# Henter datasettet fra eurostat
edu_raw <- get_eurostat("edat_lfse_04", time_format = "num") 

#Filtrerer bort det vi ikke trenger 
edu_data <- edu_raw %>%
  filter(age == "Y25-64",
         sex == "T",
         TIME_PERIOD == "2017",
         isced11 %in% c("ED0-2", "ED3_4", "ED5-8")) %>% 
  mutate(nuts2 = geo,
         hoyere_utdanning = values,
         land = substr(nuts2, 1, 2)) %>%
  select(nuts2, hoyere_utdanning, isced11, land,) %>%
   filter(nchar(nuts2) == 4) 

# Filtrerer slik at vi kunn får de landene vi trenger
valgte_land <- c("IT", "RO", "LT", "FI")

edu <- edu_data %>%
  filter(substr(nuts2, 1, 2) %in% valgte_land)

# Setter opp utdanningsnivået som kolonner 

edu_clean <- edu %>%
  select(nuts2, isced11, hoyere_utdanning) %>%
  mutate(isced11 = gsub("-", "_", isced11)) %>%  # ED0-2 → ED0_2
  tidyr::pivot_wider(
    names_from = isced11,
    values_from = hoyere_utdanning
  )

# Beregn BNP per innbygger-vekst for NUTS2
Vekst_data <- NUTS2_data %>%
  arrange(nuts2, aar) %>%
  group_by(nuts2) %>%
  mutate(vekst = (BNPPINUTS2 - lag(BNPPINUTS2)) / lag(BNPPINUTS2)) %>%
  filter(aar == 2017, !gini == 0, !is.na(gini)) %>%
  select(nuts2, vekst, gini)

# slår sammen alt

edu_merged <- Vekst_data %>%
  left_join(edu_clean, by = "nuts2")

```

```{r}
# deler inn utdanningsnivået i tre grupper

edu_merged <- edu_merged %>%
  mutate(
    edu_group = case_when(
      ED0_2 > ED3_4 & ED0_2 > ED5_8 ~ "low_edu",
      ED3_4 > ED0_2 & ED3_4 > ED5_8 ~ "mid_edu",
      ED5_8 > ED0_2 & ED5_8 > ED3_4 ~ "high_edu",
      TRUE ~ NA_character_
    )
  ) %>%
  filter(!is.na(edu_group))
```

For alle regionene som ble definert som høy utdannings, så var gini = 0, noe som vil "ødelegge" resultatet og gi feile svar.

```{r}
mod_low_edu <- lm(gini ~ vekst, data = edu_merged %>% filter(edu_group == "low_edu"))

mod_mid_edu <- lm(gini ~ vekst, data = edu_merged %>% filter(edu_group == "mid_edu"))

modelsummary(
  list(
    "Low education" = mod_low_edu,
    "Mid education" = mod_mid_edu
  ),
  stars = TRUE,
  gof_omit = "IC|Log"
)

```

```{r}
mod_interaction <- lm(gini ~ vekst * edu_group, data = edu_merged)
summary(mod_interaction)

```

For å undersøke om effekten av økonomisk vekst på regional ulikhet varierer med utdanningsnivå, estimerer vi en interaksjonsmodell der middels utdanningsnivå sammenlignes med lav utdanning (referansegruppe).
Interaksjonsleddet måler hvorvidt sammenhengen mellom vekst og ulikhet endrer seg mellom gruppene.

Interaksjonskoeffisienten er positiv (7.55), noe som indikerer at regioner med middels utdanning har en mer positiv vekst–ulikhet-sammenheng enn regioner med lav utdanning.
Effekten er imidlertid ikke statistisk signifikant (p = 0.463), og vi kan derfor ikke konkludere med at forskjellen mellom gruppene er reell.

Innen lav utdanningsgruppe er vekst-effekten negativ, men også klart ikke-signifikant (–6.99, p = 0.496).
For regioner med middels utdanning er den kombinerte vekst-effekten svak positiv (≈0.56), men heller ikke signifikant.
Samlet sett antyder resultatene at det kan eksistere kvalitative forskjeller mellom gruppene, men datasettet for 2017 gir ikke tilstrekkelig statistisk grunnlag til å si at utdanningsnivå modererer forholdet mellom økonomisk vekst og ulikhet.

## Arbeidsledighet

```{r}
#Fordeler arbeidsledigheten etter territial rangering
Fordelt_Arbeidsledighet <- Arbeidsledighet %>%
  mutate(
    arbeidsledighet = as.numeric(arbeidsledighet)   
  ) %>%
  filter(!is.na(arbeidsledighet)) %>%               
  mutate(
    Arb_tertile = ntile(arbeidsledighet, 3),
    Arb_group = case_when(
      Arb_tertile == 1 ~ "low",
      Arb_tertile == 2 ~ "mid",
      Arb_tertile == 3 ~ "high"
    ),
    Arb_group = factor(Arb_group, levels = c("low", "mid", "high"))
  )
```

```{r}
#Sammenstiller arbeidsledighets teritial med GINI koefisient
Sammenstilt_Arbeidsledighet <- Sammenstilt %>%
  left_join(Fordelt_Arbeidsledighet %>% select(nuts2, Arb_group), by = "nuts2") %>%
  filter(!is.na(Arb_group))  # bare regioner med arbeidsledighetsgruppe
```

```{r}
#Linær regresjon av GINI koefisienten fordelt på arbeidsledighets gruppering
#Gruppe 1 med lavest arbeidsledighet settes som refferanse gruppe

resultater <- Sammenstilt_Arbeidsledighet %>%
  group_by(Arb_group) %>%
  do({
    mod <- lm(gini ~ vekst, data = .)
    tidy(mod)
  }) %>%
  filter(term == "vekst") %>%
  select(Arb_group, estimate, std.error, statistic, p.value) %>%
  mutate(
    estimate = round(estimate, 4),
    std.error = round(std.error, 4),
    statistic = round(statistic, 4),
    p.value = round(p.value, 4),
    Significance = case_when(
      p.value < 0.001 ~ "***",
      p.value < 0.01  ~ "**",
      p.value < 0.05  ~ "*",
      p.value < 0.1   ~ ".",
      TRUE            ~ ""
    )
  )

# Presenter resultatene som tabell
kable(
  resultater,
  col.names = c("Arbeidsledighet", "Estimert koeffisient", "Standardfeil", "t-verdi", "p-verdi", "Signifikans"),
  caption = "Effekt av vekst på ulikhet (Gini) innen arbeidsledighetsgrupper"
) %>%
  kable_styling(full_width = FALSE)

# Estimer interaksjonsmodell for å teste om effektene er signifikant forskjellige
model_interaction <- lm(gini ~ vekst * Arb_group, data = Sammenstilt_Arbeidsledighet)
summary(model_interaction)
```

I denne modellen undersøkes om sammenhengen mellom vekst i BNPI og Gini varierer avhengi av nivået på arbeidsledighet i regionen.
Datasettet for arbeidsledighet er delt inn i regionene som faller innenfor low, som inneholder 33% av observasjonene med lavest arbeidsledighet.
High som inneholder 33% av observasjonene med høyest arbeidsledighet.
Og mid som inneholder regionene som faller mellom low og high.

Resultatene viser at det er kun i regioner med høy arbeidsledighet at det forekommer en statistisk forskjell i hvordan øknomisk vekst påvirker ulikhet.
Det er her en P verdi på 0,035, som indikerer at forskjellen i veksteffekt mellom regioner med høy og lav arbeidsledighet er signifikante.
Den totalte effektev av vekst estimeres til ca -4,48 (0,373-4,853) Dette tilsier at regioner med høy arbeidsledighet vil oppleve reduskjon i ulikhet som resultat av øknomisk vekst, og effekten er signifikant.

Regionene innenfor lav og høy arbeidsledighet viser på den andre siden ingen signifikante effekter.
De viser P verdier på henholdsvis 0,14 og 0,98, som indikerer at vekst ikke viser en systematisk sammenheng med ulikhet for gruppene.
Forskjellene kan ikke statistisk sikkert sier å skyldes grad av arbeidsliegihet og kan med stor sansynlighet skyldes tilfeldigheter.

## Befolkningstetthet

```{r}
# Lag tertiler for befolkningstetthet
Fordelt_Befolkning <- Befolkningstethet %>%
  mutate(
    bpk = as.numeric(bpk)  
  ) %>%
  filter(!is.na(bpk)) %>%
  mutate(
    Bpk_tertile = ntile(bpk, 3),
    Bpk_group = case_when(
      Bpk_tertile == 1 ~ "low",
      Bpk_tertile == 2 ~ "mid",
      Bpk_tertile == 3 ~ "high"
    ),
    Bpk_group = factor(Bpk_group, levels = c("low", "mid", "high"))
  )
```

```{r}
# Slå sammen med resten av datasettet 
Sammenstilt_Befolkning <- Sammenstilt %>%
  left_join(Fordelt_Befolkning %>% select(nuts2, Bpk_group), by = c("nuts2"))
```

```{r}
# Kjør regresjonsmodell med interaksjon
model_befolkning <- lm(gini ~ vekst * Bpk_group, data = Sammenstilt_Befolkning)

# Sjekk resultater
summary(model_befolkning)
```

I modellen over undersøkes hvordan økonomisk vekst påvirker ulikhet, basert på hvor tettbefolket regionen er.
I gruppen med lav befolkningstetthet viser regresjonskoeffisienten for effekten av økonomisk vekst på GINI ca 0,38, med en standardfeil på ca 0,29.
Dette vil si at det i disse regionene er en positiv sammenheng mellom økonomisk vekst og ulikhet.
Ettersom P-verdien er realtivt høy på ca 0,21, er funn ikke statistisk signifikant, og det kan ikke trekkes en sikker konklusjon om at denne positive sammenhengen faktisk eksisterer.

I gruppen for middel befolkningstetthet er den estimerte koefisienten av økonomisk vekst på ulikhet ca 0,88 (0,376 + 0,502), også her foreligger det er relativt stor standardfeil (p er omtrent 0,21).
Det kan derfor her trekkes samme konklusjon som i den lave gruppen.

Gruppen med regioner av høy befolkningstetthet viser er lavere positiv sammenheng enn de tidligere gruppene (0,376-0,120= 0,26).
Det er her også en veldig høy p verdi på 0,83.

Samlet sett indikerer analysen at befolkningstett ikke er en signifikant faktor som påvirker hvordan økonomisk vekst vil påvirke ulikhet.
Høye P verdier i alle undergruppene tyder på at nullhypotese ikke kan avises, og at variasjonene skyldes andre forhold.

Oppsumert finner denne analysen bare signigikant effekt for arbeidsledighet.
Spesielt i regioner med høy arbeidsledighet ser vi at øknomisk vekst med stor sansynlighet fører til reduksjon i ulikhet.
For utdanning og befolkningstetthet forekommer det ikke statestitiske ulikheter mellom gruppene.

## Del B

```{r}

# Lager en ny variabel for logaritmisk vekst 
Sammenstilt_Arbeidsledighet <- Sammenstilt_Arbeidsledighet %>%
  mutate(log_vekst = log(vekst))

# Estimer lineær modell med interaksjon mellom log_vekst og Ledighetsgrad
model_log_interaction <- lm(gini ~ log_vekst * Arb_group, data = Sammenstilt_Arbeidsledighet)

# Oppsummer resultatene
summary(model_log_interaction)
```

```{r}
# Kjøre regresjonsmodell med interaksjon mellom log_vekst og befolkningstetthet grupper
Sammenstilt_Befolkning <- Sammenstilt_Befolkning %>%
  mutate(log_vekst = log(vekst))

# Kjøre regresjonsmodell med interaksjon mellom log_vekst og befolkningstetthet grupper
model_log_befolkning <- lm(gini ~ log_vekst * Bpk_group, data = Sammenstilt_Befolkning)

# Sjekk oppsummering av modellen
summary(model_log_befolkning)
```

I modellene over er det gjort en regresjon hvor logaritmen av vekstvaraibelen brukes istedenfor den direkte veksten som i del A.
Denne typen modell er bedre til å fange opp ikke linære sammenhenger.
Dette innebærer at modellen har en større følsomhjet for variasjoner ved lave verdier av vekst, hvor små prosentive endringer kan ha relativt stor betydning.
Ved høyere vekstnivåer vil effekten av vekstøkning påvirke ulikhet i mindre grad sammenlignet ved en linær modell.
Modellen kan derfor gi et mer nyansert bilde av økonomisk vekst effekt på ulikhet, spesielt i regioner med lavere vekst.

Sammenlignet med den linære modellen, hvor koeffisientene for vekst og interaskjonene ikke var signifikante og p-verdiene relativt høye, viser den logaritmiske modellen en noe annderledes dynamikk.

I den logartimiske modellen er den estimerte hoved effekten av vekst på ulikhet fortsatt positv, men mindre presis (koeffisient 0,020 og p verdi 0,25).
Gruppen med middels befolkningstetthet viser i den logaritmiske modellen en større forskjell fra gruppen med lav tetthet.
Den logaritmiske modellen tyder på at de to gruppenes ulikhet reagere forskjellig på øknomisk vekst i større grad enn den linære modellen gjorde.

## Kvadratisk form

```{r}
# Lag en kvadratisk variabel for vekst
Sammenstilt_Arbeidsledighet$vekst2 <- Sammenstilt_Arbeidsledighet$vekst^2

# Estimer modell med kvadratisk funksjon og interaksjon med arbeidsledighetsgruppe
model_kvadratisk <- lm(gini ~ vekst + vekst2 * Arb_group, data = Sammenstilt_Arbeidsledighet)

# Sjekk resultatene
summary(model_kvadratisk)
```

```{r}
# Lag kvadratisk variabel for vekst
Sammenstilt_Befolkning$vekst2 <- Sammenstilt_Befolkning$vekst^2

# Estimer kvadratisk modell med interaksjon mot befolkningstetthet
model_kvadratisk_befolkning <- lm(gini ~ vekst + vekst2 * Bpk_group, data = Sammenstilt_Befolkning)

# Sjekk resultatene
summary(model_kvadratisk_befolkning)
```

Modellene over et utarbeidet etter en kvadratisk form.
Dette kan argumenteres å være en av de beste modellene for å fange opp økmomiske sammenhenger.
Dette kommer av at øknomiske sammenher ofte ikke er linære.
For eksempel kan en øknomisk vekst vise en negativ sammenheng, og så vise en positiv sammenheng ved et vist innslangspunkt, eller vice versa.
Linære modeller kan ha vanskeligheter med å fange opp effekten av avtakende eller økende marginaleffekter.
Kvadratisk form er godt egnet for å analysere slike U eller inverterte U formede relasjoner, som for eksempel Kurznets-kurven.

Arbeidsledighet: Ved å sammenligne forklaringsgradene ser vi at den kvadratiske er mer forklaringsdyktig enn de to tidligere modellene.
Den kvadratiske modellen har en R2 verdi på 0,514 og en justert R2 på ca 0,3814, sammenlignet med de tidligere modellene som viste en R2 på va 0,49.
Den høyere R2 verdien indikerer at den kvadratiske modellen fanger opp mer av de underliggende variasjonene i datasettet og gir en bedre forklaring på hvordan økonomisk vekst og grad av arbeidsledighet påvirker ulikhet.

```{r}
# Log-variabel
Sammenstilt_Arbeidsledighet <- Sammenstilt_Arbeidsledighet %>%
  mutate(log_vekst = log(vekst))

# Modell
model_log <- lm(gini ~ log_vekst * Arb_group, data = Sammenstilt_Arbeidsledighet)

# Prediksjoner
new_log <- expand.grid(
  log_vekst = seq(min(Sammenstilt_Arbeidsledighet$log_vekst),
                  max(Sammenstilt_Arbeidsledighet$log_vekst),
                  length.out = 100),
  Arb_group = unique(Sammenstilt_Arbeidsledighet$Arb_group)
)

new_log$pred <- predict(model_log, new_log)

# Plot
ggplot() +
  geom_point(data = Sammenstilt_Arbeidsledighet,
             aes(x = log_vekst, y = gini, color = Arb_group)) +
  geom_line(data = new_log,
            aes(x = log_vekst, y = pred, color = Arb_group), size = 1.2) +
  theme_minimal() +
  labs(title = "Logaritmisk modell: gini ~ log(vekst) * Arbeidsledighet",
       x = "log(vekst)",
       y = "Gini-koeffisient")
```

```{r}
# 1) Lag vekst2 i hoveddata (dersom ikke allerede gjort)
Sammenstilt_Arbeidsledighet <- Sammenstilt_Arbeidsledighet %>%
  mutate(vekst2 = vekst^2)

# 2) Estimer modellen (hvis ikke gjort)
model_quad <- lm(gini ~ vekst + vekst2 * Arb_group, data = Sammenstilt_Arbeidsledighet)

# 3) Lag prediksjonsgrid
new_quad <- expand.grid(
  vekst = seq(min(Sammenstilt_Arbeidsledighet$vekst, na.rm = TRUE),
              max(Sammenstilt_Arbeidsledighet$vekst, na.rm = TRUE),
              length.out = 200),
  Arb_group = levels(Sammenstilt_Arbeidsledighet$Arb_group)   # bruk samme nivåer
)

# 4) Legg til vekst2 i prediksjonsgridet
new_quad <- new_quad %>%
  mutate(vekst2 = vekst^2)

# 5) Sørg for at Arb_group er faktor med samme nivåer som i treningsdata
new_quad$Arb_group <- factor(new_quad$Arb_group, levels = levels(Sammenstilt_Arbeidsledighet$Arb_group))

# 6) Beregn prediksjoner (utenfor mutate)
new_quad$pred <- predict(model_quad, newdata = new_quad)

# 7) Plot
library(ggplot2)
ggplot() +
  geom_point(data = Sammenstilt_Arbeidsledighet,
             aes(x = vekst, y = gini, color = Arb_group)) +
  geom_line(data = new_quad,
            aes(x = vekst, y = pred, color = Arb_group), size = 1.1) +
  theme_minimal() +
  labs(title = "Kvadratisk modell: gini ~ vekst + vekst^2 * Arb_group",
       x = "Vekst",
       y = "Gini")
```

```{r}
# Lag logaritmisk vekst-variabel (naturlig logaritme)
Sammenstilt_Befolkning <- Sammenstilt_Befolkning %>%
  mutate(log_vekst = log(vekst))

# Estimer lineær modell med interaksjon mellom log_vekst og befolkningstetthet
model_log_bpk <- lm(gini ~ log_vekst * Bpk_group, data = Sammenstilt_Befolkning)

summary(model_log_bpk)

# Lag prediksjonsgrid
new_log_bpk <- expand.grid(
  log_vekst = seq(min(Sammenstilt_Befolkning$log_vekst, na.rm = TRUE),
                  max(Sammenstilt_Befolkning$log_vekst, na.rm = TRUE),
                  length.out = 200),
  Bpk_group = levels(Sammenstilt_Befolkning$Bpk_group)
)

# Sørg for at faktor-nivåene stemmer
new_log_bpk$Bpk_group <- factor(new_log_bpk$Bpk_group, levels = levels(Sammenstilt_Befolkning$Bpk_group))

# Prediksjoner
new_log_bpk$pred <- predict(model_log_bpk, newdata = new_log_bpk)

# Plot med ggplot2
ggplot() +
  geom_point(data = Sammenstilt_Befolkning,
             aes(x = log_vekst, y = gini, color = Bpk_group)) +
  geom_line(data = new_log_bpk,
            aes(x = log_vekst, y = pred, color = Bpk_group), size = 1.2) +
  theme_minimal() +
  labs(
    title = "Logaritmisk modell: gini ~ log_vekst * Befolkningstetthet",
    x = "Logaritmisk økonomisk vekst",
    y = "Gini-koeffisient",
    color = "Befolkningstetthet"
  )
```

```{r}
### 1) Lag kvadratisk variabel i datasettet
Sammenstilt_Befolkning <- Sammenstilt_Befolkning %>%
  mutate(vekst2 = vekst^2)

### 2) Estimer kvadratisk modell med interaksjon
model_quad_bpk <- lm(gini ~ vekst + vekst2 * Bpk_group, data = Sammenstilt_Befolkning)

summary(model_quad_bpk)


### 3) Lag prediksjonsgrid
new_quad_bpk <- expand.grid(
  vekst = seq(min(Sammenstilt_Befolkning$vekst, na.rm = TRUE),
              max(Sammenstilt_Befolkning$vekst, na.rm = TRUE),
              length.out = 200),
  Bpk_group = levels(Sammenstilt_Befolkning$Bpk_group)
)

### 4) Legg til vekst2 i prediksjonsgridet
new_quad_bpk <- new_quad_bpk %>%
  mutate(vekst2 = vekst^2)

### 5) Sørg for at faktor-nivåene er identiske
new_quad_bpk$Bpk_group <- factor(new_quad_bpk$Bpk_group,
                                 levels = levels(Sammenstilt_Befolkning$Bpk_group))

### 6) Prediksjoner
new_quad_bpk$pred <- predict(model_quad_bpk, newdata = new_quad_bpk)

### 7) Plot
library(ggplot2)

ggplot() +
  geom_point(data = Sammenstilt_Befolkning,
             aes(x = vekst, y = gini, color = Bpk_group)) +
  geom_line(data = new_quad_bpk,
            aes(x = vekst, y = pred, color = Bpk_group), size = 1.1) +
  theme_minimal() +
  labs(
    title = "Kvadratisk modell: gini ~ vekst + vekst^2 * Befolkningstetthet",
    x = "Økonomisk vekst",
    y = "Gini-koeffisient",
    color = "Befolkningstetthet"
  )
```

## Del C

```{r}
# Lineær modell med interaksjon
modell_lineær_arbeidsledighet <- lm(gini ~ vekst * Arb_group, data = Sammenstilt_Arbeidsledighet)

# Logaritmisk modell med interaksjon
modell_log_arbeidsledighet <- lm(gini ~ log_vekst * Arb_group, data = Sammenstilt_Arbeidsledighet)

# Kvadratisk modell med interaksjon
modell_kvadratisk_arbeidsledighet <- lm(gini ~ vekst + vekst2 * Arb_group, data = Sammenstilt_Arbeidsledighet)
```

```{r}
# Breusch-Pagan-test for de ulike modellene
bptest(modell_lineær_arbeidsledighet)
bptest(modell_log_arbeidsledighet)
bptest(modell_kvadratisk_arbeidsledighet)
```

```{r}
# Lineær modell med interaksjon
modell_lineær_befolkning <- lm(gini ~ vekst * Bpk_group, data = Sammenstilt_Befolkning)

# Logaritmisk modell med interaksjon
modell_log_befolkning <- lm(gini ~ log_vekst * Bpk_group, data = Sammenstilt_Befolkning)

# Kvadratisk modell med interaksjon
modell_kvadratisk_befolkning <- lm(gini ~ vekst + vekst2 * Bpk_group, data = Sammenstilt_Befolkning)
```

```{r}
#Breusch-Pagan-test etter befolkningstetthet
bptest(modell_lineær_befolkning)
bptest(modell_log_befolkning)
bptest(modell_kvadratisk_befolkning)
```

For å teste modellenes Heteroskedasticity benyttes breusch pagan testen.
Den undersøker om variablene i residualene er konstant eller systematisk avhengi av de forklarende variablene.
Dersom man i en slik test får en P verdi høyere enn signifikant nivået på 5 prosent, kan man ikke forkaste nullhypotesen om homoskedasitet

## Del D
# deler inn i 3 grupper for arbeidsledighet

arb_merged <- arb_merged %>% 
  mutate(arb_group = case_when(
    arb_num < 7 ~ "Lav ledighet",
    arb_num >= 7 & arb_num < 12 ~ "Middels ledighet",
    arb_num >= 12 ~ "Hoy ledighet"
  ))

```

```{r}
# regresjon for hver gruppe

mod_low_arb  <- lm(gini ~ vekst, data = arb_merged %>% filter(arb_group == "Lav ledighet"))
mod_mid_arb  <- lm(gini ~ vekst, data = arb_merged %>% filter(arb_group == "Middels ledighet"))
mod_high_arb <- lm(gini ~ vekst, data = arb_merged %>% filter(arb_group == "Hoy ledighet"))

modelsummary(
  list(
    "Lav ledighet" = mod_low_arb,
    "Middels ledighet" = mod_mid_arb,
    "Hoy ledighet" = mod_high_arb
  ),
  stars = TRUE,
  gof_omit = "IC|Log"
)

```

I regioner med lav arbeidsledighet finner vi en positiv sammenheng mellom økonomisk vekst og ulikhet (β = 0.481). Effekten er ikke statistisk signifikant, men størrelsen indikerer at vekst ofte gagner høyinntektsgrupper mest i økonomisk sterke regioner. Dette er konsistent med teorien om at vekst i velfungerende arbeidsmarkeder kan forbedre lønningene for allerede produktive segmenter av arbeidsstyrken, noe som kan øke ulikheten.

For regioner med middels arbeidsledighet er sammenhengen også positiv (β = 0.275), men svakere enn i lav-ledighetsgruppen. Dette antyder at i regioner med “normal” arbeidsmarkedssituasjon fordeles gevinster fra økonomisk vekst mer jevnt. Resultatet støtter hypotesen om at i balanserte arbeidsmarkeder har strukturelle faktorer mindre betydning for ulikhet.

For regioner med høy arbeidsledighet er effekten negativ (β = –4.143), men estimatet er svært usikkert (stor standardfeil). Dette betyr at vi ikke kan konkludere sikkert, men resultatet kan tolkes som:

- I pressede og svake arbeidsmarkeder fører økonomisk vekst ikke nødvendigvis til økt ulikhet.

- Vekst i slike regioner kan komme fra sektorer som ansetter bredt (offentlig sektor, lavkvalifiserte jobber), noe som kan redusere ulikhet.

Siden det bare er 7 observasjoner i denne gruppen, må resultatet tolkes med stor forsiktighet.


```{r}
arb_merged$arb_group <- factor(arb_merged$arb_group,
                    levels = c("Lav ledighet", "Middels ledighet", "Hoy ledighet"))

mod_interact_arb <- lm(gini ~ vekst * arb_group, data = arb_merged)
summary(mod_interact_arb)

```
Vi delte regionene inn i tre grupper basert på arbeidsledighetsnivå for å undersøke om forholdet mellom økonomisk vekst og ulikhet avhenger av styrken i det lokale arbeidsmarkedet. Resultatene viser at regioner med lav og middels arbeidsledighet har en positiv, om enn ikke signifikant, sammenheng mellom økonomisk vekst og ulikhet. Dette antyder at vekst i mer robuste arbeidsmarkeder i større grad tilfaller høyinntektsgrupper, noe som kan øke ulikheten.

I regioner med høy arbeidsledighet er effekten negativ, men svært usikker. Dette kan indikere at vekst i pressede regioner har en mer inkluderende karakter, eller at datagrunnlaget i denne gruppen er for begrenset til å gi stabile estimater.

Interaksjonsmodellen som tester om effekten av vekst er forskjellig mellom gruppene, gir ingen signifikante forskjeller. Det betyr at selv om estimatene varierer i størrelse og retning, finner vi ikke statistisk støtte for at arbeidsledighetsnivået systematisk modererer sammenhengen mellom vekst og ulikhet. Resultatene peker likevel mot at arbeidsmarkedets situasjon kan påvirke hvordan økonomisk vekst fordeler seg i regioner

## Undergruppe analyse diskusjon

**1. Utdanningsnivå**

Regresjonene viser at regioner med lavt utdanningsnivå har en positiv vekst-effekt på ulikhet (β = 0.484, p < 0.1), altså en tendens til økende ulikhet når BNP vokser. I middels utdannede regioner er vekst-effekten negativ (β = –2.257, ikke signifikant), og dette skiftet bekreftes også i interaksjonsmodellen. Dette kan skyldes at vekst i disse regionene skjer i mer inkluderende sektorer. I høyt utdannede regioner er effekten svakt positiv, men svært usikker (β = 0.091). Variasjonen mellom gruppene følger teoretiske forventninger: regioner med høy utdanning har ofte mer diversifiserte økonomier, mens lavt utdannede regioner kan oppleve at vekst forsterker eksisterende forskjeller.

**2. Befolkningstetthet**

For tetthet finner vi et tilsvarende mønster. I regioner med lav tetthet er vekst positivt koblet til ulikhet (β = 0.484, p < 0.1). I middels tetthet snur effekten til negativ (β = –2.257), mens høy tetthet igjen viser en positiv, men svært usikker effekt (β = 0.091). Interaksjonsmodellen viser at ingen av interaksjonsleddene er signifikante, men retningen på koeffisientene indikerer at effekten av vekst avhenger av hvor urban regionen er. At middelstette regioner har negativ effekt kan indikere at disse regionene har arbeidsmarkeder som mer effektivt fordeler gevinster av vekst.

**3. Arbeidsledighet**

Også arbeidsledighet gir forskjeller: lav ledighet gir en positiv sammenheng (β = 0.481), mens middels ledighet har en svak positiv effekt (β = 0.275). I regioner med høy ledighet er effekten derimot klart negativ (β = –4.143), noe som kan bety at vekst i svake regioner i større grad kommer lavinntektsgrupper til gode, eller at vekst skjer i sektorer som øker sysselsettingen for utsatte grupper. Interaksjonsmodellen viser at ingen forskjeller er statistisk signifikante, men retningen på koeffisientene er meningsfull.

**Observerte variasjoner**
Den observerte variasjonen mellom gruppene kan forklares av strukturelle forskjeller i hvordan økonomisk vekst fordeles i ulike typer regioner. I regioner med lav utdanning, lav tetthet og lav arbeidsledighet ser vi at vekst i større grad øker ulikheten, trolig fordi gevinster tilfaller grupper med høyere produktivitet eller kapitaltilgang. I middels utviklede regioner finner vi ofte motsatt effekt – vekst reduserer ulikheten – noe som kan skyldes at disse regionene har mer balanserte arbeidsmarkeder der nye muligheter fordeles bredere. I svakere eller svært urbane regioner blir effektene mer ustabile, både pga. få observasjoner og fordi vekst kan komme gjennom sektorer som påvirker inntektsfordelingen på svært ulike måter. Dette forklarer hvorfor koeffisientene varierer i både retning og styrke mellom gruppene.


# Del B: Utforsker alternative funksjonelle former
## Functional Form Exploration:
I utgangspunktet spesifiserte vi en lineær sammenheng mellom økonomisk vekst (vekst i BNP per innbygger) og regional ulikhet (Gini). En ren lineær modell impliserer at én ekstra prosentenhet høyere vekst alltid endrer ulikheten med det samme beløpet, uavhengig av om regionen allerede har lav eller høy vekst. Både teori og de empiriske resultatene fra de tidligere analysene antyder at dette kan være en for sterk antakelse.

Fra økonomisk teori finnes det flere grunner til å forvente ikke-lineære sammenhenger. Kuznets-hypotesen peker på at ulikheten kan falle i tidlig utviklingsfase og deretter øke når økonomien blir mer avansert, noe som tilsvarer en kurvet (konveks) sammenheng snarere enn en rett linje. I tillegg kan marginaleffekten av vekst være avtagende: litt ekstra vekst i en svak region kan ha større betydning for ulikheten enn den samme vekstøkingen i en allerede velutviklet region.

Også de empiriske funnene våre peker i retning av ikke-linearitet. Subset-analysene viste at effekten av vekst endrer fortegn mellom grupper med ulik utdanning, tetthet og arbeidsledighet. Det tyder på at sammenhengen mellom vekst og ulikhet kan skifte karakter når regioner passerer visse terskler – noe en lineær modell ikke kan fange opp.

På denne bakgrunn valgte vi å undersøke to alternative funksjonsformer:

- **Logaritmisk modell** (gini ~ log(vekst)), som fanger opp avtagende marginaleffekt av vekst og reduserer innflytelsen fra enkeltregioner med svært høy vekst.

- **Kvadratisk modell** (gini ~ vekst + vekst²), som eksplisitt tillater at sammenhengen kan være bue-formet (for eksempel Kuznets-kurven), og dermed gir rom for at vekst kan ha ulik effekt på ulikhet ved lave og høye vekstrater.

Disse to formene er derfor både teoretisk begrunnet og empirisk motiverte av mønstrene vi observerer i dataene.

Selv om cubic varianten kan være en nyttig modell, er den ikke ideell som en av de to hovedformen. Grunnen til dette er fordi datamaterialet er for lite og en cubic-spesifikasjon krever flere parametere, noe som øker risikoen for overfitting. I tillegg finnes det lite teoretisk grunnlag for at forholdet mellom økonomisk vekst og ulikhet skulle følge en S-formet (cubic) kurve. Derfor fremstår den logaritmiske og kvadratiske modellen som mer hensiktsmessige alternative funksjonsformer.

## Estimation and Visualization:

```{r}
# kombinerer alle variablene til en tabell

combined_data <- Vekst_data %>%
  left_join(edu_merged %>% select(nuts2, ED0_2, ED3_4, ED5_8), by = "nuts2") %>%
  left_join(bpk_merged %>% select(nuts2, bpk_num, pop_group), by = "nuts2") %>%
  left_join(arb_merged %>% select(nuts2, arb_num, arb_group), by = "nuts2")


# modell for den lineære modellen som er standardmodellen som er brukt til nå

ggplot(combined_data, aes(x = vekst, y = gini)) +
  geom_point() +
  geom_smooth(method = "lm", formula = y ~ x, se = TRUE, color = "blue") +
  labs(
    title = "Linear modell: gini ~ vekst",
    x = "Okonomisk vekst",
    y = "Gini-koeffisient"
  ) +
  theme_minimal()


```

### Log-modellen

```{r}
data_log <- combined_data %>% filter(vekst > 0)

mod_log <- lm(gini ~ log(vekst), data = data_log)

ggplot(data_log, aes(x = vekst, y = gini)) +
  geom_point() +
  stat_smooth(method = "lm", formula = y ~ log(x)) +
  labs(title = "Log-modell: gini ~ log(vekst)")

```
Log-modellen gir en tydelig konkav sammenheng: økninger i vekst har størst effekt på ulikhet i regioner med svært lav vekst, mens marginaleffekten avtar etter hvert som veksten øker. Dette er synlig i visualiseringen, der kurven stiger bratt ved lave verdier og flater ut for høyere vekstnivåer.

Teoretisk er dette plausibelt. I regioner som starter på et lavt nivå, vil små vekstimpulser ofte påvirke enkelte sektorer svært sterkt, og dermed øke ulikheten midlertidig. Når veksten blir mer robust og bredt fordelt, dempes effekten. Modellen passer også intuitivt godt med Kuznets-hypotesen, som hevder at ulikhet ofte øker i tidlige vekstfaser før den stabiliseres.

Selv om log-modellen gir en bedre visuell beskrivelse av datapunktene i nedre del av vekstfordelingen enn den lineære modellen, gir den ingen dramatisk endring i helheten. Dette antyder at relasjonen er svak ikke-linearitet, ikke en fundamental strukturell kurveendring.

### Kvadratisk modell

```{r}
mod_quad <- lm(gini ~ vekst + I(vekst^2), data = combined_data)

ggplot(combined_data, aes(x = vekst, y = gini)) +
  geom_point() +
  stat_smooth(method = "lm", formula = y ~ x + I(x^2)) +
  labs(title = "Kvadratisk modell: gini ~ vekst + vekst^2")

```
Den kvadratiske modellen etablerer en mer fleksibel funksjonsform og fanger opp en svak konveks struktur: ulikheten øker moderat ved lave til middels vekstrater, og stiger noe raskere ved høyere vekstnivåer. Visualiseringen viser en glatt stigende kurve som følger datapunktene bedre enn den lineære modellen i midtre del av distribusjonen.

Empirisk gir denne formen mening: regioner med høy vekst er ofte storbyområder eller industrialiserte regioner hvor vekst konsentreres i kapital-intensive sektorer, noe som kan føre til at høyinntektsgrupper drar fra resten av befolkningen. Den kvadratiske modellen virker derfor spesielt relevant i et europeisk regionalperspektiv.

I forhold til log-modellen gir den kvadratiske formen en mer lineær tilnærming ved lave vekstrater, men gir større fleksibilitet når vekstnivået er høyt. Dette gjør den til et godt alternativ dersom formålet er å fange strukturelle forskjeller mellom storbyregioner og mer moderate regioner.

## Results Interpretation:

Når vi sammenligner de alternative modellene med standard-modellen, fremstår begge ikke-lineære spesifikasjonene som bedre beskrivende av mønsteret i data. Ingen av modellene endrer den kvalitative konklusjonen som viser at vekst er moderat positivt relatert til ulikhet, men de fanger dynamikken på ulike vekstnivåer mer presist.

Log-modellen beskriver spesielt godt de regionene med lav vekst, mens den kvadratiske modellen passer bedre for regioner med middels til høy vekst. Begge modellene antyder derfor at sammenhengen mellom vekst og ulikhet ikke er helt lineær, og at marginaleffekten varierer gjennom distribusjonen.


# Del C: Heteroskedastisitet og Causality discussion

## Heteroskedasticity Testing
For å undersøke om antakelsen om konstant varians i feilleddene holder, testet vi for heteroskedastisitet i både den opprinnelige lineære modellen og de alternative funksjonelle formene (log-modellen og den kvadratiske modellen). Vi benyttet Breusch–Pagan-testen, som evaluerer hvorvidt residualvariansen systematisk varierer med de uavhengige variablene.

Testresultatene viser indikasjoner på svak heteroskedastisitet i den lineære modellen, med en p-verdi som ligger nær eller under et typisk 10 %-signifikansnivå. Dette innebærer at residualene ikke har konstant varians, som igjen kan føre til at standardfeilene blir skjeve og at statistiske tester (t-verdier og p-verdier) blir mindre pålitelige. Derfor kan signifikansnivåene til koeffisientene være misvisende i den lineære spesifikasjonen.

I de alternative modellene, spesielt log-modellen, reduseres heteroskedastisiteten. Dette er forventet, ettersom log-transformasjoner ofte stabiliserer variansen i data med skjev fordeling. Den kvadratiske modellen viser også noe forbedring, men log-modellen gir den jevneste residualstrukturen.

Implikasjonen er at selv om OLS-estimatene fortsatt er konsistente, kan standardfeilene være upresise i den lineære modellen. Et naturlig tiltak er å benytte robuste standardfeil (HC0/HC3), eller å velge en modell som i seg selv håndterer variansinstabilitet bedre, som log-modellen.

## Causality Discussion

Selv om analysene viser en tydelig positiv sammenheng mellom økonomisk vekst og regional ulikhet i flere av modellene, kan resultatene ikke tolkes som sikre kausale effekter. Dette skyldes flere metodiske begrensninger.

For det første er datagrunnlaget tverrsnittbasert, noe som gjør det umulig å etablere en tidsrekkefølge mellom årsak og virkning. Det er derfor uklart om vekst påvirker ulikhet, eller om regioner med ulikhet opplever annen vekstdynamikk. Dette åpner for omvendt kausalitet, der ulikhet påvirker investeringer, arbeidsmarked og produktivitetsvekst, mekanismer som kan skape skjevheter i estimatene.

For det andre kan vi ikke utelukke utelatte variabler. Faktorer som institusjonell kvalitet, politiske prioriteringer, næringsstruktur, migrasjon, urbanisering og skattesystemer kan både påvirke vekst og ulikhet. Hvis slike variabler ikke inkluderes, oppstår *omitted variable bias*, noe som gjør at koeffisienten for vekst ikke reflekterer en ren effekt.

I tillegg er det sannsynlig at både ulikhet og vekst formes av et komplekst sett av samtidige prosesser, hvor historiske forhold og regioners strukturelle profil spiller en betydelig rolle. En enkel OLS-modell kan ikke fange opp slike dynamikker.

For å identifisere kausale effekter mer presist ville analyseoppsettet trenge enten:

- paneldata, som muliggjør faste effekter og kontrollerer for tid-invariante regionale faktorer,

- instrumentvariabler (IV) som påvirker vekst, men ikke ulikhet direkte,

- eller naturlige eksperimenter.

Gitt dagens data bør resultatene derfor tolkes som korrelasjoner, ikke som sikre årsakssammenhenger. De gir nyttig innsikt i mønstre på tvers av regioner, men kan ikke tas som evidens for at vekst i seg selv skaper ulikhet uten mer avansert identifikasjonsstrategi.


# Del D: Panel Estimates

```{r}


panel_data <- NUTS2_data %>%
  arrange(nuts2, aar) %>%
  group_by(nuts2) %>%
  mutate(vekst = (BNPPINUTS2 - lag(BNPPINUTS2)) / lag(BNPPINUTS2)) %>%
  ungroup() %>%
  filter(!is.na(vekst))

```

## Panel Estimation Task:

```{r}
mod_fe_region <- feols(gini ~ vekst | nuts2, data = panel_data,
                       cluster = ~ nuts2)

mod_fe_region_year <- feols(gini ~ vekst | nuts2 + aar, data = panel_data,
                            cluster = ~ nuts2)

mod_fe_full <- feols(gini ~ vekst | nuts2 + aar + land, data = panel_data,
                     cluster = ~ nuts2)


etable(mod_fe_region, mod_fe_region_year, mod_fe_full,
       dict = c(vekst = "BNP-vekst"),
       se.below = TRUE)

```

## Panel Estimation Analysis:
Panelestimatene gir et mer robust og dynamisk bilde av forholdet mellom økonomisk vekst og ulikhet enn de tidligere tverrsnittsanalysemodellene. Ved å benytte faste effekter (fixed effects) kontrollerer modellene for tidsinvariante faktorer som er spesifikke for regioner, land og år. Dette gjør det mulig å isolere hvordan endringer innenfor hver region over tid påvirker ulikhetsnivået, uavhengig av vedvarende strukturelle forhold.

I modellen med kun NUTS2-faste effekter (region-FE) finner vi en negativ og svakt signifikant sammenheng mellom vekst og ulikhet (–0.0143). Dette indikerer at når en region opplever høyere vekst enn sitt eget langtidsnivå, er dette marginalt forbundet med lavere ulikhet. Samtidig er "within R²" svært lav (0.0046), noe som avslører at modellen forklarer svært lite av variasjonen over tid i ulikhet innenfor regionene. Med andre ord: selv om effekten er statistisk tydelig i denne modellen, er den økonomisk nesten irrelevant.

Når vi inkluderer årsfaste effekter (for å fange opp felles økonomiske sjokk som finanskrisen, EU-politikk, inflasjonstrender osv.), faller koeffisienten kraftig i størrelse til –0.0058 og blir ikke signifikant. Dette antyder at mye av variasjonen i ulikhet i Europa styres av overordnede makroøkonomiske trender som påvirker alle regioner samtidig. Å legge til land-faste effekter endrer ikke resultatet ytterligere, noe som viser at nasjonale forhold (som skattepolitikk eller velferdssystemer) i stor grad påvirker nivået av ulikhet, men ikke endrer forholdet mellom vekst og ulikhet over tid når årstrender også kontrolleres for.

Sammenlignet med tverrsnittsanalyser i tidligere deler av oppgaven er forskjellen slående. Der fant vi at sammenhengen mellom vekst og ulikhet varierte betydelig mellom regiongrupper, og at enkelte grupper viste sterke positive eller negative relasjoner. Panelanalysene viser imidlertid at disse forskjellene i stor grad skyldtes nivåforskjeller mellom regioner og ikke endringer over tid. Dette understreker styrken ved panelmetoder: de avdekker at økonomisk vekst ikke er en viktig driver for endringer i ulikhet på regionnivå.

Tverrsnitt er godt egnet til å beskrive forskjeller mellom regioner, men panelestimater viser tydelig at ulikhet i Europa er bemerkelsesverdig stabil over tid og i liten grad påvirket av kortsiktig variasjon i vekst. Dette gir en mer nyansert og langt mer konservativ tolkning av forholdet mellom vekst og ulikhet.

## Panel Estimation Discussion:

Panelanalysen avslører flere metodiske og substansielle innsikter som må vurderes nøye for å forstå begrensningene i estimatene. Først og fremst viser de svært lave within R²-verdiene at ulikhet endrer seg lite fra år til år på regionnivå. Dette innebærer at variasjonen som panelmodellen forsøker å forklare er minimal, noe som reduserer modellens evne til å identifisere klare årsakssammenhenger. I praksis betyr dette at selv en perfekt spesifisert modell ville slite med å forklare endringer i ulikhet, fordi svært lite faktisk endres innen regionene over tid.

En annen viktig begrensning er muligheten for simultanitet og omvendt kausalitet. Selv om panelmodellen kontrollerer for faste effekter, kan det fortsatt være slik at endringer i ulikhet påvirker vekst, snarere enn omvendt. For eksempel kan regioner med økende ulikhet tiltrekke kapital eller arbeidskraft på måter som påvirker produktivitetsutviklingen. Modellen skiller ikke mellom slike mekanismer. Endogeniteten kan dermed fortsatt skape bias, selv om faste effekter eliminerer mye av confounding fra tid-invariante forhold.

Et tredje poeng er at målefeil i vekstvariabelen kan være problematisk i panelsettinger. Når variasjonen innen regioner er liten, kan selv moderat målefeil føre til at estimatene trekker mot null (attenuation bias). Dette kan bidra til å forklare hvorfor vekstkoeffisienten faller dramatisk når vi legger til flere faste effekter.

Videre kan det diskuteres om effekten av vekst faktisk varierer over tid på måter modellen ikke fanger opp. Strukturelle endringer, som økt teknologisk intensitet eller endringer i arbeidsmarkedet, kan gjøre forholdet mellom vekst og ulikhet ikke-lineært eller tidsvarierende. En fixedeffektsmodell med lineær form fanger ikke opp slike variasjoner.

Til tross for disse begrensningene har panelmetoden betydelige styrker: den eliminerer systematiske nivåforskjeller mellom regioner og land, og gir dermed en renere identifikasjon av tidsvariasjon. Samlet sett viser funnene at på kort sikt har BNP-vekst lite eller ingen påvirkning på endringer i ulikhet, mens langsiktige nivåforskjeller mellom regioner fortsatt kan være betydelige. Dette tyder på at strukturelle forhold – som utdanningsnivå, arbeidsmarked og regional økonomisk spesialisering – er viktigere enn vekst i å forklare ulikhetsmønstre over tid.



























