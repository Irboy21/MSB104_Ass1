---
title: "Assignment 3 — MSB104 — Group 3"
author: "Irjan & Magnus"
format:
  html: default
  pdf: default
execute:
  echo: false
  warning: false
  message: false
---

```{r, include=FALSE}
library(modelr)
library(dplyr)
library(ggplot2)
library(tidyverse)
library(vtable)
library(flextable)
library(scales)
library(tinytex)
library(readxl)
library(stringr)
library(janitor)
library(tidyr)
library(dineq) 
library(knitr)
library(ggrepel)
library(modelsummary)
library(broom)
library(lmtest)
library(plm)
```

```{r}
NUTS2_data <- readRDS("data/NUTS2_data.rds")
```

```{r}
# Beregn BNP per innbygger-vekst for NUTS2
Vekst_data <- NUTS2_data %>%
  arrange(nuts2, aar) %>%
  group_by(nuts2) %>%
  mutate(vekst = (BNPPINUTS2 - lag(BNPPINUTS2)) / lag(BNPPINUTS2)) %>%
  filter(aar == 2017) %>%
  select(nuts2, vekst, gini)
```

```{r}
library(eurostat)
library(dplyr)

# Henter datasettet fra eurostat
edu_raw <- get_eurostat("edat_lfse_04", time_format = "num") 

#Filtrerer bort det vi ikke trenger 
edu_data <- edu_raw %>%
  filter(age == "Y25-64",
         sex == "T",
         TIME_PERIOD == "2017",
         isced11 %in% c("ED0-2", "ED3_4", "ED5-8")) %>% 
  mutate(nuts2 = geo,
         hoyere_utdanning = values,
         land = substr(nuts2, 1, 2)) %>%
  select(nuts2, hoyere_utdanning, isced11, land,) %>%
   filter(nchar(nuts2) == 4) 

# Filtrerer slik at vi kunn får de landene vi trenger
valgte_land <- c("IT", "RO", "LT", "FI")

edu <- edu_data %>%
  filter(substr(nuts2, 1, 2) %in% valgte_land)

# Setter opp utdanningsnivået som kolonner 

edu_clean <- edu %>%
  select(nuts2, isced11, hoyere_utdanning) %>%
  mutate(isced11 = gsub("-", "_", isced11)) %>%  # ED0-2 → ED0_2
  tidyr::pivot_wider(
    names_from = isced11,
    values_from = hoyere_utdanning
  )

# Beregn BNP per innbygger-vekst for NUTS2
Vekst_data <- NUTS2_data %>%
  arrange(nuts2, aar) %>%
  group_by(nuts2) %>%
  mutate(vekst = (BNPPINUTS2 - lag(BNPPINUTS2)) / lag(BNPPINUTS2)) %>%
  filter(aar == 2017, !gini == 0, !is.na(gini)) %>%
  select(nuts2, vekst, gini)

# slår sammen alt

edu_merged <- Vekst_data %>%
  left_join(edu_clean, by = "nuts2")

```

```{r}
# deler inn utdanningsnivået i tre grupper

edu_merged <- edu_merged %>%
  mutate(
    edu_group = case_when(
      ED0_2 > ED3_4 & ED0_2 > ED5_8 ~ "low_edu",
      ED3_4 > ED0_2 & ED3_4 > ED5_8 ~ "mid_edu",
      ED5_8 > ED0_2 & ED5_8 > ED3_4 ~ "high_edu",
      TRUE ~ NA_character_
    )
  ) %>%
  filter(!is.na(edu_group))
```

For alle regionene som ble definert som høy utdannings, så var gini = 0, noe som vil "ødelegge" resultatet og gi feile svar.

```{r}
mod_low <- lm(gini ~ vekst, data = edu_merged %>% filter(edu_group == "low_edu"))

mod_mid <- lm(gini ~ vekst, data = edu_merged %>% filter(edu_group == "mid_edu"))

modelsummary(
  list(
    "Low education" = mod_low,
    "Mid education" = mod_mid
  ),
  stars = TRUE,
  gof_omit = "IC|Log"
)

```

```{r}
mod_interaction <- lm(gini ~ vekst * edu_group, data = edu_merged)
summary(mod_interaction)

```

For å undersøke om effekten av økonomisk vekst på regional ulikhet varierer med utdanningsnivå, estimerer vi en interaksjonsmodell der middels utdanningsnivå sammenlignes med lav utdanning (referansegruppe).
Interaksjonsleddet måler hvorvidt sammenhengen mellom vekst og ulikhet endrer seg mellom gruppene.

Interaksjonskoeffisienten er positiv (7.55), noe som indikerer at regioner med middels utdanning har en mer positiv vekst–ulikhet-sammenheng enn regioner med lav utdanning.
Effekten er imidlertid ikke statistisk signifikant (p = 0.463), og vi kan derfor ikke konkludere med at forskjellen mellom gruppene er reell.

Innen lav utdanningsgruppe er vekst-effekten negativ, men også klart ikke-signifikant (–6.99, p = 0.496).
For regioner med middels utdanning er den kombinerte vekst-effekten svak positiv (≈0.56), men heller ikke signifikant.
Samlet sett antyder resultatene at det kan eksistere kvalitative forskjeller mellom gruppene, men datasettet for 2017 gir ikke tilstrekkelig statistisk grunnlag til å si at utdanningsnivå modererer forholdet mellom økonomisk vekst og ulikhet.

## Arbeidsledighet

```{r}
#Fordeler arbeidsledigheten etter territial rangering
Fordelt_Arbeidsledighet <- Arbeidsledighet %>%
  mutate(
    arbeidsledighet = as.numeric(arbeidsledighet)   
  ) %>%
  filter(!is.na(arbeidsledighet)) %>%               
  mutate(
    Arb_tertile = ntile(arbeidsledighet, 3),
    Arb_group = case_when(
      Arb_tertile == 1 ~ "low",
      Arb_tertile == 2 ~ "mid",
      Arb_tertile == 3 ~ "high"
    ),
    Arb_group = factor(Arb_group, levels = c("low", "mid", "high"))
  )
```

```{r}
#Sammenstiller arbeidsledighets teritial med GINI koefisient
Sammenstilt_Arbeidsledighet <- Sammenstilt %>%
  left_join(Fordelt_Arbeidsledighet %>% select(nuts2, Arb_group), by = "nuts2") %>%
  filter(!is.na(Arb_group))  # bare regioner med arbeidsledighetsgruppe
```

```{r}
#Linær regresjon av GINI koefisienten fordelt på arbeidsledighets gruppering
#Gruppe 1 med lavest arbeidsledighet settes som refferanse gruppe

resultater <- Sammenstilt_Arbeidsledighet %>%
  group_by(Arb_group) %>%
  do({
    mod <- lm(gini ~ vekst, data = .)
    tidy(mod)
  }) %>%
  filter(term == "vekst") %>%
  select(Arb_group, estimate, std.error, statistic, p.value) %>%
  mutate(
    estimate = round(estimate, 4),
    std.error = round(std.error, 4),
    statistic = round(statistic, 4),
    p.value = round(p.value, 4),
    Significance = case_when(
      p.value < 0.001 ~ "***",
      p.value < 0.01  ~ "**",
      p.value < 0.05  ~ "*",
      p.value < 0.1   ~ ".",
      TRUE            ~ ""
    )
  )

# Presenter resultatene som tabell
kable(
  resultater,
  col.names = c("Arbeidsledighet", "Estimert koeffisient", "Standardfeil", "t-verdi", "p-verdi", "Signifikans"),
  caption = "Effekt av vekst på ulikhet (Gini) innen arbeidsledighetsgrupper"
) %>%
  kable_styling(full_width = FALSE)

# Estimer interaksjonsmodell for å teste om effektene er signifikant forskjellige
model_interaction <- lm(gini ~ vekst * Arb_group, data = Sammenstilt_Arbeidsledighet)
summary(model_interaction)
```

I denne modellen undersøkes om sammenhengen mellom vekst i BNPI og Gini varierer avhengi av nivået på arbeidsledighet i regionen.
Datasettet for arbeidsledighet er delt inn i regionene som faller innenfor low, som inneholder 33% av observasjonene med lavest arbeidsledighet.
High som inneholder 33% av observasjonene med høyest arbeidsledighet.
Og mid som inneholder regionene som faller mellom low og high.

Resultatene viser at det er kun i regioner med høy arbeidsledighet at det forekommer en statistisk forskjell i hvordan øknomisk vekst påvirker ulikhet.
Det er her en P verdi på 0,035, som indikerer at forskjellen i veksteffekt mellom regioner med høy og lav arbeidsledighet er signifikante.
Den totalte effektev av vekst estimeres til ca -4,48 (0,373-4,853) Dette tilsier at regioner med høy arbeidsledighet vil oppleve reduskjon i ulikhet som resultat av øknomisk vekst, og effekten er signifikant.

Regionene innenfor lav og høy arbeidsledighet viser på den andre siden ingen signifikante effekter.
De viser P verdier på henholdsvis 0,14 og 0,98, som indikerer at vekst ikke viser en systematisk sammenheng med ulikhet for gruppene.
Forskjellene kan ikke statistisk sikkert sier å skyldes grad av arbeidsliegihet og kan med stor sansynlighet skyldes tilfeldigheter.

## Befolkningstetthet

```{r}
# Lag tertiler for befolkningstetthet
Fordelt_Befolkning <- Befolkningstethet %>%
  mutate(
    bpk = as.numeric(bpk)  # Gjør om til numerisk hvis nødvendig
  ) %>%
  filter(!is.na(bpk)) %>%
  mutate(
    Bpk_tertile = ntile(bpk, 3),
    Bpk_group = case_when(
      Bpk_tertile == 1 ~ "low",
      Bpk_tertile == 2 ~ "mid",
      Bpk_tertile == 3 ~ "high"
    ),
    Bpk_group = factor(Bpk_group, levels = c("low", "mid", "high"))
  )
```

```{r}
# Slå sammen med resten av datasettet (hvis ikke allerede gjort)
Sammenstilt_Befolkning <- Sammenstilt %>%
  left_join(Fordelt_Befolkning %>% select(nuts2, Bpk_group), by = c("nuts2"))
```

```{r}
# Kjør regresjonsmodell med interaksjon
model_befolkning <- lm(gini ~ vekst * Bpk_group, data = Sammenstilt_Befolkning)

# Sjekk resultater
summary(model_befolkning)
```

I modellen over undersøkes hvordan økonomisk vekst påvirker ulikhet, basert på hvor tettbefolket regionen er.
I gruppen med lav befolkningstetthet viser regresjonskoeffisienten for effekten av økonomisk vekst på GINI ca 0,38, med en standardfeil på ca 0,29.
Dette vil si at det i disse regionene er en positiv sammenheng mellom økonomisk vekst og ulikhet.
Ettersom P-verdien er realtivt høy på ca 0,21, er funn ikke statistisk signifikant, og det kan ikke trekkes en sikker konklusjon om at denne positive sammenhengen faktisk eksisterer.

I gruppen for middel befolkningstetthet er den estimerte koefisienten av økonomisk vekst på ulikhet ca 0,88 (0,376 + 0,502), også her foreligger det er relativt stor standardfeil (p er omtrent 0,21).
Det kan derfor her trekkes samme konklusjon som i den lave gruppen.

Gruppen med regioner av høy befolkningstetthet viser er lavere positiv sammenheng enn de tidligere gruppene (0,376-0,120= 0,26).
Det er her også en veldig høy p verdi på 0,83.

Samlet sett indikerer analysen at befolkningstett ikke er en signifikant faktor som påvirker hvordan økonomisk vekst vil påvirke ulikhet.
Høye P verdier i alle undergruppene tyder på at nullhypotese ikke kan avises, og at variasjonene skyldes andre forhold.

Oppsumert finner denne analysen bare signigikant effekt for arbeidsledighet.
Spesielt i regioner med høy arbeidsledighet ser vi at øknomisk vekst med stor sansynlighet fører til reduksjon i ulikhet.
For utdanning og befolkningstetthet forekommer det ikke statestitiske ulikheter mellom gruppene.

## Del B

```{r}

# Lager en ny variabel for logaritmisk vekst (naturlig log)
Sammenstilt_Arbeidsledighet <- Sammenstilt_Arbeidsledighet %>%
  mutate(log_vekst = log(vekst))

# Estimer lineær modell med interaksjon mellom log_vekst og Ledighetsgrad
model_log_interaction <- lm(gini ~ log_vekst * Arb_group, data = Sammenstilt_Arbeidsledighet)

# Oppsummer resultatene
summary(model_log_interaction)
```

```{r}
# Kjøre regresjonsmodell med interaksjon mellom log_vekst og befolkningstetthet grupper
Sammenstilt_Befolkning <- Sammenstilt_Befolkning %>%
  mutate(log_vekst = log(vekst))

# Kjøre regresjonsmodell med interaksjon mellom log_vekst og befolkningstetthet grupper
model_log_befolkning <- lm(gini ~ log_vekst * Bpk_group, data = Sammenstilt_Befolkning)

# Sjekk oppsummering av modellen
summary(model_log_befolkning)
```

I modellene over er det gjort en regresjon hvor logaritmen av vekstvaraibelen brukes istedenfor den direkte veksten som i del A.
Denne typen modell er bedre til å fange opp ikke linære sammenhenger.
Dette innebærer at modellen har en større følsomhjet for variasjoner ved lave verdier av vekst, hvor små prosentive endringer kan ha relativt stor betydning.
Ved høyere vekstnivåer vil effekten av vekstøkning påvirke ulikhet i mindre grad sammenlignet ved en linær modell.
Modellen kan derfor gi et mer nyansert bilde av økonomisk vekst effekt på ulikhet, spesielt i regioner med lavere vekst.

Sammenlignet med den linære modellen, hvor koeffisientene for vekst og interaskjonene ikke var signifikante og p-verdiene relativt høye, viser den logaritmiske modellen en noe annderledes dynamikk.

I den logartimiske modellen er den estimerte hoved effekten av vekst på ulikhet fortsatt positv, men mindre presis (koeffisient 0,020 og p verdi 0,25).
Gruppen med middels befolkningstetthet viser i den logaritmiske modellen en større forskjell fra gruppen med lav tetthet.
Den logaritmiske modellen tyder på at de to gruppenes ulikhet reagere forskjellig på øknomisk vekst i større grad enn den linære modellen gjorde.

## Kvadratisk form

```{r}
# Lag en kvadratisk variabel for vekst
Sammenstilt_Arbeidsledighet$vekst2 <- Sammenstilt_Arbeidsledighet$vekst^2

# Estimer modell med kvadratisk funksjon og interaksjon med arbeidsledighetsgruppe
model_kvadratisk <- lm(gini ~ vekst + vekst2 * Arb_group, data = Sammenstilt_Arbeidsledighet)

# Sjekk resultatene
summary(model_kvadratisk)
```

```{r}
# Lag kvadratisk variabel for vekst
Sammenstilt_Befolkning$vekst2 <- Sammenstilt_Befolkning$vekst^2

# Estimer kvadratisk modell med interaksjon mot befolkningstetthet
model_kvadratisk_befolkning <- lm(gini ~ vekst + vekst2 * Bpk_group, data = Sammenstilt_Befolkning)

# Sjekk resultatene
summary(model_kvadratisk_befolkning)
```

Modellene over et utarbeidet etter en kvadratisk form.
Dette kan argumenteres å være en av de beste modellene for å fange opp økmomiske sammenhenger.
Dette kommer av at øknomiske sammenher ofte ikke er linære.
For eksempel kan en øknomisk vekst vise en negativ sammenheng, og så vise en positiv sammenheng ved et vist innslangspunkt, eller vice versa.
Linære modeller kan ha vanskeligheter med å fange opp effekten av avtakende eller økende marginaleffekter.
Kvadratisk form er godt egnet for å analysere slike U eller inverterte U formede relasjoner, som for eksempel Kurznets-kurven.

Arbeidsledighet: Ved å sammenligne forklaringsgradene ser vi at den kvadratiske er mer forklaringsdyktig enn de to tidligere modellene.
Den kvadratiske modellen har en R2 verdi på 0,514 og en justert R2 på ca 0,3814, sammenlignet med de tidligere modellene som viste en R2 på va 0,49.
Den høyere R2 verdien indikerer at den kvadratiske modellen fanger opp mer av de underliggende variasjonene i datasettet og gir en bedre forklaring på hvordan økonomisk vekst og grad av arbeidsledighet påvirker ulikhet.

```{r}
# Log-variabel
Sammenstilt_Arbeidsledighet <- Sammenstilt_Arbeidsledighet %>%
  mutate(log_vekst = log(vekst))

# Modell
model_log <- lm(gini ~ log_vekst * Arb_group, data = Sammenstilt_Arbeidsledighet)

# Prediksjoner
new_log <- expand.grid(
  log_vekst = seq(min(Sammenstilt_Arbeidsledighet$log_vekst),
                  max(Sammenstilt_Arbeidsledighet$log_vekst),
                  length.out = 100),
  Arb_group = unique(Sammenstilt_Arbeidsledighet$Arb_group)
)

new_log$pred <- predict(model_log, new_log)

# Plot
ggplot() +
  geom_point(data = Sammenstilt_Arbeidsledighet,
             aes(x = log_vekst, y = gini, color = Arb_group)) +
  geom_line(data = new_log,
            aes(x = log_vekst, y = pred, color = Arb_group), size = 1.2) +
  theme_minimal() +
  labs(title = "Logaritmisk modell: gini ~ log(vekst) * Arbeidsledighet",
       x = "log(vekst)",
       y = "Gini-koeffisient")
```

```{r}
# 1) Lag vekst2 i hoveddata (dersom ikke allerede gjort)
Sammenstilt_Arbeidsledighet <- Sammenstilt_Arbeidsledighet %>%
  mutate(vekst2 = vekst^2)

# 2) Estimer modellen (hvis ikke gjort)
model_quad <- lm(gini ~ vekst + vekst2 * Arb_group, data = Sammenstilt_Arbeidsledighet)

# 3) Lag prediksjonsgrid
new_quad <- expand.grid(
  vekst = seq(min(Sammenstilt_Arbeidsledighet$vekst, na.rm = TRUE),
              max(Sammenstilt_Arbeidsledighet$vekst, na.rm = TRUE),
              length.out = 200),
  Arb_group = levels(Sammenstilt_Arbeidsledighet$Arb_group)   # bruk samme nivåer
)

# 4) Legg til vekst2 i prediksjonsgridet
new_quad <- new_quad %>%
  mutate(vekst2 = vekst^2)

# 5) Sørg for at Arb_group er faktor med samme nivåer som i treningsdata
new_quad$Arb_group <- factor(new_quad$Arb_group, levels = levels(Sammenstilt_Arbeidsledighet$Arb_group))

# 6) Beregn prediksjoner (utenfor mutate)
new_quad$pred <- predict(model_quad, newdata = new_quad)

# 7) Plot
library(ggplot2)
ggplot() +
  geom_point(data = Sammenstilt_Arbeidsledighet,
             aes(x = vekst, y = gini, color = Arb_group)) +
  geom_line(data = new_quad,
            aes(x = vekst, y = pred, color = Arb_group), size = 1.1) +
  theme_minimal() +
  labs(title = "Kvadratisk modell: gini ~ vekst + vekst^2 * Arb_group",
       x = "Vekst",
       y = "Gini")
```

```{r}
# Lag logaritmisk vekst-variabel (naturlig logaritme)
Sammenstilt_Befolkning <- Sammenstilt_Befolkning %>%
  mutate(log_vekst = log(vekst))

# Estimer lineær modell med interaksjon mellom log_vekst og befolkningstetthet
model_log_bpk <- lm(gini ~ log_vekst * Bpk_group, data = Sammenstilt_Befolkning)

summary(model_log_bpk)

# Lag prediksjonsgrid
new_log_bpk <- expand.grid(
  log_vekst = seq(min(Sammenstilt_Befolkning$log_vekst, na.rm = TRUE),
                  max(Sammenstilt_Befolkning$log_vekst, na.rm = TRUE),
                  length.out = 200),
  Bpk_group = levels(Sammenstilt_Befolkning$Bpk_group)
)

# Sørg for at faktor-nivåene stemmer
new_log_bpk$Bpk_group <- factor(new_log_bpk$Bpk_group, levels = levels(Sammenstilt_Befolkning$Bpk_group))

# Prediksjoner
new_log_bpk$pred <- predict(model_log_bpk, newdata = new_log_bpk)

# Plot med ggplot2
ggplot() +
  geom_point(data = Sammenstilt_Befolkning,
             aes(x = log_vekst, y = gini, color = Bpk_group)) +
  geom_line(data = new_log_bpk,
            aes(x = log_vekst, y = pred, color = Bpk_group), size = 1.2) +
  theme_minimal() +
  labs(
    title = "Logaritmisk modell: gini ~ log_vekst * Befolkningstetthet",
    x = "Logaritmisk økonomisk vekst",
    y = "Gini-koeffisient",
    color = "Befolkningstetthet"
  )
```

```{r}
### 1) Lag kvadratisk variabel i datasettet
Sammenstilt_Befolkning <- Sammenstilt_Befolkning %>%
  mutate(vekst2 = vekst^2)

### 2) Estimer kvadratisk modell med interaksjon
model_quad_bpk <- lm(gini ~ vekst + vekst2 * Bpk_group, data = Sammenstilt_Befolkning)

summary(model_quad_bpk)


### 3) Lag prediksjonsgrid
new_quad_bpk <- expand.grid(
  vekst = seq(min(Sammenstilt_Befolkning$vekst, na.rm = TRUE),
              max(Sammenstilt_Befolkning$vekst, na.rm = TRUE),
              length.out = 200),
  Bpk_group = levels(Sammenstilt_Befolkning$Bpk_group)
)

### 4) Legg til vekst2 i prediksjonsgridet
new_quad_bpk <- new_quad_bpk %>%
  mutate(vekst2 = vekst^2)

### 5) Sørg for at faktor-nivåene er identiske
new_quad_bpk$Bpk_group <- factor(new_quad_bpk$Bpk_group,
                                 levels = levels(Sammenstilt_Befolkning$Bpk_group))

### 6) Prediksjoner
new_quad_bpk$pred <- predict(model_quad_bpk, newdata = new_quad_bpk)

### 7) Plot
library(ggplot2)

ggplot() +
  geom_point(data = Sammenstilt_Befolkning,
             aes(x = vekst, y = gini, color = Bpk_group)) +
  geom_line(data = new_quad_bpk,
            aes(x = vekst, y = pred, color = Bpk_group), size = 1.1) +
  theme_minimal() +
  labs(
    title = "Kvadratisk modell: gini ~ vekst + vekst^2 * Befolkningstetthet",
    x = "Økonomisk vekst",
    y = "Gini-koeffisient",
    color = "Befolkningstetthet"
  )
```

## Del C

```{r}
# Lineær modell med interaksjon
modell_lineær_arbeidsledighet <- lm(gini ~ vekst * Arb_group, data = Sammenstilt_Arbeidsledighet)

# Logaritmisk modell med interaksjon
modell_log_arbeidsledighet <- lm(gini ~ log_vekst * Arb_group, data = Sammenstilt_Arbeidsledighet1)

# Kvadratisk modell med interaksjon
modell_kvadratisk_arbeidsledighet <- lm(gini ~ vekst + vekst2 * Arb_group, data = Sammenstilt_Arbeidsledighet)
```

```{r}
# Breusch-Pagan-test for de ulike modellene
bptest(modell_lineær_arbeidsledighet)
bptest(modell_log_arbeidsledighet)
bptest(modell_kvadratisk_arbeidsledighet)
```

```{r}
# Lineær modell med interaksjon
modell_lineær_befolkning <- lm(gini ~ vekst * Bpk_group, data = Sammenstilt_Befolkning)

# Logaritmisk modell med interaksjon
modell_log_befolkning <- lm(gini ~ log_vekst * Bpk_group, data = Sammenstilt_Befolkning)

# Kvadratisk modell med interaksjon
modell_kvadratisk_befolkning <- lm(gini ~ vekst + vekst2 * Bpk_group, data = Sammenstilt_Befolkning)
```

```{r}
#Breusch-Pagan-test etter befolkningstetthet
bptest(modell_lineær_befolkning)
bptest(modell_log_befolkning)
bptest(modell_kvadratisk_befolkning)
```

## Del D

```{r}

```
