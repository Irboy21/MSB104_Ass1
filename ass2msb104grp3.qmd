---
title: "Ass2MSB104GRP3"
format: pdf
editor: visual
execute:
  echo: false
  warning: true
---

```{r, include=FALSE}
library(modelr)
library(dplyr)
library(ggplot2)
library(tidyverse)
library(vtable)
library(flextable)
library(scales)
library(tinytex)
library(readxl)
library(stringr)
library(janitor)
library(tidyr)
library(dineq) 
library(knitr)
library(ggrepel)
library(modelsummary)
library(eurostat)
```

```{r setup, include=FALSE}
Sys.setlocale("LC_ALL", "Norwegian")
```

```{r}
KombinertRen <- readRDS("data/KombinertRen.rds")
Gini_alle <- readRDS("data/Gini_alle.rds")

```

```{r}
# legger til NUTS2 i KombinertRen
Kombinert2 <- KombinertRen %>%
  mutate(nuts2 = substr(geo, 1, 4))

# Finner BNP på NUTS2 nivå
NUTS2_BNP <- Kombinert2 %>%
  group_by(nuts2, aar) %>%
  summarise(
    BNP = sum(BNP, na.rm = TRUE),
    befolkning = sum(befolkning, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(BNPPINUTS2 = BNP / befolkning * 1e6)

# legger til gini variablen inn i NUTS2_data

NUTS2_data <- NUTS2_BNP %>%
  left_join(Gini_alle, by = c("nuts2", "aar"))

```



# Del A: Vekst og Ulikhet
## Model Estimater

```{r}
# Beregn BNP per innbygger-vekst for NUTS2
Vekst_data <- NUTS2_data %>%
  arrange(nuts2, aar) %>%
  group_by(nuts2) %>%
  mutate(vekst = (BNPPINUTS2 - lag(BNPPINUTS2)) / lag(BNPPINUTS2)) %>%
  filter(aar == 2017, gini != 0, !is.na(gini)) %>%
  select(nuts2, vekst, gini)

# Estimer enkel lineær regresjon
mod1 <- lm(gini ~ vekst, data = Vekst_data)

```

 
## Model Diagnostikk

```{r}


modelsummary(
  list("Model 1: GINI ~ Vekst" = mod1),
  statistic = "({std.error})",
  stars = TRUE,
  gof_omit = "IC|Log|F",
  output = "markdown",
  title = "Enkel regresjonsmodel. {#tbl-reg1}"
)

summary(mod1)
```


Resultatene fra den enkle lineære regresjonsmodellen (se @tbl-reg1) viser at økonomisk vekst (Vekst) har en positiv og statistisk signifikant sammenheng med regional ulikhet (GINI) på NUTS2-nivå i 2017. Koeffisienten til vekst (β₁ = 0.538, SE = 0.160) indikerer at regioner med høyere vekst i BNP per innbygger også har høyere grad av ulikhet. Dette funnet peker mot et mønster av regional divergens, hvor økonomisk vekst i større grad samles i allerede velstående regioner.

Modellens konstantledd (β₀ = 0.044) representerer forventet ulikhet i regioner uten økonomisk vekst, altså et GINI-nivå på rundt 0.044. Forklaringskraften er moderat (R² = 0.295, justert R² = 0.269), noe som innebærer at omtrent 30 % av variasjonen i ulikhet kan forklares av vekstforskjeller mellom regionene. Resten av variasjonene må tilskrives andre faktorer som ikke inngår i denne modellen. Disse variablene kan for eksempel være utdanning, demografi og eller næringsstruktur. Residualstandardfeilen (RMSE ≈ 0.04) viser at modellens prediksjoner har relativ små avvik fra observerte verdier.

Vider så kan vi se på F statistikken for å finne ut av hvor sannsynlig det for at variablene er signifikante. I vår regresjonsmodell kommer det frem en F-statistikk på 11.3 og en p-verdi på 0.0023. F-statistikk på 11.3 er ganske høyt, noe som betyr at variasjonen forklart av modellen er betydelig større enn det man forventer fra tilfeldigheter. En p-verdi på 0.0023 betyr at det er en 0.23% sannsynlighet for å få et så sterkt resultat dersom det ikke finnes en sammenheng mellom variablene. Dersom vi bruker en vanlig signifikansnivå 5%, så er 0.0023 mye lavere enn 0.05, altså kan vi forkaste nullhypotesen (altså at det ikke er noen effekt eller sammenheng)


## Visualisering
```{r}

ggplot(Vekst_data, aes(x = vekst, y = gini)) +
  geom_point(color = "blue") +
  geom_smooth(method = "lm", se = TRUE, color = "darkred") +
  labs(
    title = "Regional ulikhet vs Vekst i BNP per innbygger (2017, NUTS2)",
    x = "Vekst i BNP per innbygger (2016–2017)",
    y = "Regional ulikhet (Gini)"
  ) +
  theme_minimal()

```


# Del B: Utforsker andre determinanter for ulikhet

## Data Tilhenting

### Utdanning - andel av befolkningen med høyere utdanning

```{r}
edu_raw <- get_eurostat("edat_lfse_04", time_format = "num")

# Lager en landskode variabel slik at jeg kan filtrere bort uønskede land
edu_raw <- edu_raw %>%
   mutate(land = substr(geo, 1, 2))


edu_data <- edu_raw %>%
  filter(age == "Y25-64",           # aldersgruppen 25–64 år
         sex == "T",                # total (begge kjønn)
         isced11 == "ED5-8",        # tertiær utdanning
         TIME_PERIOD == 2017) %>%
  select(geo, TIME_PERIOD, values, land) %>%
  rename(
    nuts2 = geo,
    aar = TIME_PERIOD,
    Utdanningsverdi = values) %>%
  filter(nchar(nuts2) == 4)

#
selected_countries <- c("FI", "IT", "LT", "RO")

edu_data <- edu_data %>%
  filter(substr(nuts2, 1, 2) %in% selected_countries)

```

### Arbeidsledighet

```{r}
unemp_raw <- get_eurostat("lfst_r_lfu3rt", time_format = "num")


unemp_data <- unemp_raw %>%
  filter(sex == "T", age == "Y15-74", TIME_PERIOD == 2017) %>%
  select(geo, TIME_PERIOD, values) %>%
  rename(
    nuts2 = geo,
    aar = TIME_PERIOD,
    unemployment_rate = values) %>%
    filter(nchar(nuts2) == 4)

unemp_data <- unemp_data %>%
  filter(substr(nuts2, 1, 2) %in% selected_countries)

# slår sammen og finner gjennomsnittet av duplikatene
unemp_data <- unemp_data %>%
  group_by(nuts2) %>%
  summarise(
    unemployment_rate = mean(unemployment_rate, na.rm = TRUE)
  ) %>%
  ungroup()

# Rydder opp i desimaler
unemp_data <- unemp_data %>%
  mutate(unemployment_rate = round(unemployment_rate, 1))


```

### Transport-infrastruktur - motorveiglengde per region

```{r}
road_raw <- get_eurostat("tran_r_net", time_format = "num")

road_data <- road_raw %>%
  filter(tra_infr == "MWAY", TIME_PERIOD == 2017) %>%
  select(geo, TIME_PERIOD, values) %>%
  rename(
    nuts2 = geo,
    aar = TIME_PERIOD,
    motorway_km = values) %>%
  filter(nchar(nuts2) == 4)

road_data <- road_data %>%
  filter(substr(nuts2, 1, 2) %in% selected_countries)
# 
# road_data <- road_data %>%
#   group_by(nuts2) %>%
#   summarise(
#     motorway_km = mean(motorway_km, na.rm = TRUE)
#   ) %>%
#   ungroup()
# 
# road_data <- road_data %>%
#   mutate(motorway_km = round(motorway_km, 1))
```
### Slår sammen alle datasettene

```{r}
# filtrer ut landene som ikke er ønsket


```














