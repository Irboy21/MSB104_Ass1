---
title: "Ass2MSB104GRP3"
format: pdf
editor: visual

execute:
  echo: false
  warning: false
  message: false
bibliography: references.bib
---

```{r, include=FALSE}
library(modelr)
library(dplyr)
library(ggplot2)
library(tidyverse)
library(vtable)
library(flextable)
library(scales)
library(tinytex)
library(readxl)
library(stringr)
library(janitor)
library(tidyr)
library(dineq) 
library(knitr)
library(ggrepel)
library(modelsummary)
library(broom)

```

```{r setup, include=FALSE}
Sys.setlocale("LC_ALL", "Norwegian")

```

```{r}
KombinertRen <- readRDS("data/KombinertRen.rds")
Gini_alle <- readRDS("data/Gini_alle.rds")

```

```{r}
# legger til NUTS2 i KombinertRen
Kombinert2 <- KombinertRen %>%
  mutate(nuts2 = substr(geo, 1, 4))

# Finner BNP på NUTS2 nivå
NUTS2_BNP <- Kombinert2 %>%
  group_by(nuts2, aar) %>%
  summarise(
    BNP = sum(BNP, na.rm = TRUE),
    befolkning = sum(befolkning, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(BNPPINUTS2 = BNP / befolkning * 1e6)

# legger til gini variablen inn i NUTS2_data

NUTS2_data <- NUTS2_BNP %>%
  left_join(Gini_alle, by = c("nuts2", "aar"))

```

# Del A: Vekst og Ulikhet

I @lessmann2017 sin tekst vil effekten man vil forvente å se på GINI koefisienten avhenge om regionen man ser på er rik eller fattig fra før.
I rikere land forventer man en negativ sammenheng mellom vekst og ulikhet, dvs at vekst fører til reduserte ulikheter mellom regioner.
Dette kommer av at i rikere land er vil i stor grad de rike regionene være såpass velstående at verdiøkningen ønskes sentrert i de områdene som er underuviklet sett i sammenheng med resten av landet.
I fattigere regioner forventer man på den andre siden å se en positiv sammenheng mellom vekst og ulikhet.
Dette kalles "kuznets" effekten.
Ettersom regresjonsanalysen ga en positiv ß1 verdi, burde det etter kuznets effekten indikere at datasettets inneholder mest regioner med lavere velstand relativt sett.

## Model Diagnostikk

```{r}
# Beregn BNP per innbygger-vekst for NUTS2
Vekst_data <- NUTS2_data %>%
  arrange(nuts2, aar) %>%
  group_by(nuts2) %>%
  mutate(vekst = (BNPPINUTS2 - lag(BNPPINUTS2)) / lag(BNPPINUTS2)) %>%
  filter(aar == 2017, gini != 0, !is.na(gini)) %>%
  select(nuts2, vekst, gini)

# Estimer enkel lineær regresjon
model1 <- lm(gini ~ vekst, data = Vekst_data)
```

```{r}


modelsummary(
  list("Model 1: GINI ~ Vekst" = model1),
  statistic = "({std.error})",
  stars = FALSE,
  gof_omit = "IC|Log|F",
  output = "markdown",
  title = "Enkel regresjonsmodel. {#tbl-reg1}"
)

```

```{r}
tidy_model1 <- broom::tidy(model1) %>%
  mutate(
    Significance = case_when(
      p.value < 0.001 ~ "***",
      p.value < 0.01  ~ "**",
      p.value < 0.05  ~ "*",
      p.value < 0.1   ~ ".",
      TRUE            ~ ""
    )
  ) %>%
  rename(
    Variabel = term,
    Estimate = estimate,
    `Std. Error` = std.error,
    `t-verdi` = statistic,
    `p-verdi` = p.value
  ) %>%
  select(Variabel, Estimate, `Std. Error`, `t-verdi`, `p-verdi`, Significance)

kable(
  tidy_model1,
  digits = 4,
  caption = "Regresjonsresultater for modellen",
  col.names = c("Variabel", "Estimert koeffisient", "Standardfeil", "t-verdi", "p-verdi", "Signifikans")
)
```

I funksjonen over fremkommer analysegrunnlaget som skal brukes i regresjons modellen.
Vekst er sattt som uavhengi variabel, og GINI koefisienten som avhengi variabel.
Med dette datasettet kan vi teste @lessmann2017 sin teori om at det er en sammenheng mellom økonomisk vekst of ulikhet.

Resultatene fra den enkle lineære regresjonsmodellen (se @tbl-reg1) viser at økonomisk vekst (Vekst) har en positiv og statistisk signifikant sammenheng med regional ulikhet (GINI) på NUTS2-nivå i 2017.
Koeffisienten til vekst (β₁ = 0.538, SE = 0.160) indikerer at regioner med høyere vekst i BNP per innbygger også har høyere grad av ulikhet.
Dette funnet peker mot et mønster av regional divergens, hvor økonomisk vekst i større grad samles i allerede velstående regioner.

Modellens konstantledd (β₀ = 0.044) representerer forventet ulikhet i regioner uten økonomisk vekst, altså et GINI-nivå på rundt 0.044.

```{r}
#Goodness-of-fit tabell 

mod_sum1 <- summary(model1)

fit_stats1 <- tibble(
  Statistik = c(
    "R-squared",
    "Adjusted R-squared",
    "Residual Standard Error",
    "F-statistic",
    "F-statistic p-verdi"
  ),
  Verdi = c(
    round(mod_sum1$r.squared, 4),
    round(mod_sum1$adj.r.squared, 4),
    round(mod_sum1$sigma, 4),
    round(mod_sum1$fstatistic[1], 2),
    signif(pf(mod_sum1$fstatistic[1], mod_sum1$fstatistic[2], mod_sum1$fstatistic[3], lower.tail = FALSE), 4)
  )
)

kable(
  fit_stats1,
  caption = "Goodness-of-fit statistikk for modellen",
  col.names = c("Statistikk", "Verdi")
)
```

Forklaringskraften er moderat (R² = 0.295, justert R² = 0.269), noe som innebærer at omtrent 30 % av variasjonen i ulikhet kan forklares av vekstforskjeller mellom regionene.
Resten av variasjonene må tilskrives andre faktorer som ikke inngår i denne modellen.
Disse variablene kan for eksempel være utdanning, demografi og eller næringsstruktur.
Residualstandardfeilen (RMSE ≈ 0.04) viser at modellens prediksjoner har relativ små avvik fra observerte verdier.

Vider så kan vi se på F statistikken for å finne ut av hvor sannsynlig det for at variablene er signifikante.
I vår regresjonsmodell kommer det frem en F-statistikk på 11.3 og en p-verdi på 0.0023.
F-statistikk på 11.3 er ganske høyt, noe som betyr at variasjonen forklart av modellen er betydelig større enn det man forventer fra tilfeldigheter.
En p-verdi på 0.0023 betyr at det er en 0.23% sannsynlighet for å få et så sterkt resultat dersom det ikke finnes en sammenheng mellom variablene.
Dersom vi bruker en vanlig signifikansnivå 5%, så er 0.0023 mye lavere enn 0.05, altså kan vi forkaste nullhypotesen (altså at det ikke er noen effekt eller sammenheng)

### OLS-forutsetninger og vurderinger

Den klassiske OLS-modellen bygger på fem sentrale forutsetninger for at estimatene skal være upartiske og effektive.

Den første forutsetningen er **Lineæritet:** Dette går ut på at forholdet mellom ulikhet (Gini) og de uavhengige variablene antas å være lineært. Residualplott viser ingen klare mønstre, noe som tyder på at antakelsen holder. Ved brudd på denne forutsetningen kan det være nytt å benytte transformasjoner eller ikke-lineære modeller.

Videre har vi forutsetningen om **Uavhengighet:** I vårt datasett representerer observasjonene ulike regioner, og det kan være rimelig å anta at de fleste regionene er uavhengige. Dersom enkelte regioner er geografisk eller økonomisk tilknyttet, kan dette skape korrelasjon mellom residualene. En konsekvens av dette er feil standardfeil og misvisende signifikansnivåer. Dette kan håndteres ved å bruke cluster-robuste standardfeil.

OLS forutsetter at variansen til feilleddene er konstant (**homoskedastisk**). I praksis viser økonomiske data ofte heteroskedastisitet, spesielt mellom regioner med ulik størrelse eller inntektsnivå. Hvis denne forutsetningen brytes, påvirkes ikke koeffisientene, men standardfeilene blir feilberegnet og hypotesetester blir upålitelige. Løsningen er å bruke robuste standardfeil (HC) eller log-transformasjoner av variabler.

**Multikolinaritet:** Forklaringsvariablene skal ikke være perfekt korrelert. En korrelasjonsanalyse viser moderat sammenheng mellom utdanning og arbeidsledighet, men ikke nok til å skape problemer. Ved alvorlig multikollinearitet øker standardfeilene, og det blir vanskelig å identifisere individuelle effekter. Tiltak kan være å fjerne overlappende variabler eller bruke hovedkomponentanalyse (PCA).

Forutsetningen om **normalfordelte** feilledd er sentralt for at t-tester og konfidensintervaller skal være gyldige. Residualplottet viser at residualene i modellen følger en tilnærmet normal fordeling, selv om et mindre utvalg (N = 29) naturlig kan gi enkelte avvik. Dersom normalitetsantakelsen ikke holder, kan bootstrapping benyttes for å oppnå mer robuste og pålitelige standardfeil.

De fleste OLS-forutsetningene ser ut til å være rimelig oppfylt i denne modellen. Noe heteroskedastisitet og svak multikollinearitet kan være til stede, men dette kan håndteres ved bruk av robuste standardfeil. Samlet sett vurderes modellen som rimelig robust, selv om bruk av robuste standardfeil og kontroll for regionale sammenhenger kan forbedre påliteligheten.



## Visualisering

```{r}
#| label: fig-gini-growth
#| fig-cap: "Sammenheng mellom regional ulikhet (målt ved Gini-koeffisienten) og økonomisk vekst i BNP per innbygger for NUTS2-regioner i 2017. Figuren viser en positiv sammenheng, hvor regioner med høyere veksttakt også tenderer til å ha høyere inntektsulikhet. Den røde linjen representerer estimert lineær regresjon med 95 % konfidensintervall (grått felt)."
#| fig-width: 7
#| fig-height: 5
#| fig-pos: "H"
#| warning: false
#| message: false

ggplot(Vekst_data, aes(x = vekst, y = gini)) +
  geom_point(color = "blue") +
  geom_smooth(method = "lm", se = TRUE, color = "darkred") +
  labs(
    title = "Regional ulikhet vs Vekst i BNP per innbygger (2017, NUTS2)",
    x = "Vekst i BNP per innbygger (2016–2017)",
    y = "Regional ulikhet (Gini)"
  ) +
  theme_minimal()
```

# Del B: Utforsker andre determinanter for ulikhet

## Part B: Andre variabler som påvirker ulikhet

## Data Tilhenting

```{r}
# Henter inn Arbeidsledighet datasett fra excel
Arbeidsledighet <- read_excel("Arbeidsledighet.xlsx", sheet = 2, col_types = "text") %>%
  clean_names()
```

```{r}
# Henter inn Befolkningstetthet datasett fra excel
Befolkningstethet <- read_excel("Befolkningstethet.xlsx", sheet = 2, col_types = "text") %>%
  clean_names()

```

```{r}
# Henter inn Befolkningstetthet datasett fra excel
Hoyere_utdanning <- read_excel("Hoyere_utdanning.xlsx", sheet = 2, col_types = "text") %>%
  clean_names()

```

```{r}
Sammenstilt <- Vekst_data %>%
  select(nuts2, vekst, gini) %>%
  inner_join(Arbeidsledighet %>% select(nuts2, arbeidsledighet), by = "nuts2") %>%
  inner_join(Befolkningstethet %>% select(nuts2, bpk), by = "nuts2") %>%
  inner_join(Hoyere_utdanning %>% select(nuts2, hoyere_utdanning), by = "nuts2") %>%
  filter(
    !is.na(arbeidsledighet),
    !is.na(bpk),
    !is.na(hoyere_utdanning)
  ) %>%
  mutate(
    # Konverterer tekstverdier til numeriske
    arbeidsledighet = as.numeric(gsub(",", ".", gsub("[^0-9,\\.]", "", arbeidsledighet))),
    bpk = as.numeric(gsub(",", ".", gsub("[^0-9,\\.]", "", bpk))),
    hoyere_utdanning = as.numeric(gsub(",", ".", gsub("[^0-9,\\.]", "", hoyere_utdanning)))
  )

# Se på strukturen av datasettet for å bekrefte at alt stemmer
```

```{r}
# Sørg for at alle variabler er numeriske (ryddig og robust konvertering)
Sammenstilt <- Sammenstilt %>%
  mutate(
    across(c(arbeidsledighet, bpk, hoyere_utdanning),
           ~ as.numeric(gsub(",", ".", gsub("[^0-9,\\.]", "", .))))
  )

# Estimer multippel lineær regresjon
model_multi <- lm(gini ~ vekst + arbeidsledighet + bpk + hoyere_utdanning, data = Sammenstilt)

# Hent og formater resultater med flere desimaler for små tall
regression_results <- tidy(model_multi) %>%
  mutate(
    Estimate = ifelse(term == "bpk",
                      format(round(estimate, 6), nsmall = 6),   # flere desimaler for bpk
                      format(round(estimate, 4), nsmall = 4)),
    `Std. Error` = format(round(std.error, 4), nsmall = 4),
    `t value` = format(round(statistic, 4), nsmall = 4),
    `Pr(>|t|)` = format(round(p.value, 4), nsmall = 4)
  ) %>%
  select(term, Estimate, `Std. Error`, `t value`, `Pr(>|t|)`)

# Vis tabell
kable(
  regression_results,
  caption = "Regresjonsresultater for modell med Gini som avhengig variabel (2017)"
)
```

## Valg av variabler

Det er hentet inn 3 nye datasett som kan være med å forklare ulikhet mellom regioner.
Som det kom frem i del A gir modell \@ref(tab:passelighet) oss en forklaringskraft på ca 29%.
Det er derfor intressant å utvide modellen for å fange opp flere årsaker til ulikhet, samt å se hvor relavante andre variabler kan være.
Dataene som tilføyes er arbeidsledighet, og befolkningstethet.
Etter metadataene kommer det frem at det er populasjonen i alderen mellom 15 og 74 år som er tatt med i datasettet.

Arbeidsledighet er målt i prosent, og sier hvor stor andel av befolkningen innenfor NUTS2 regionene som er arbeidsledige.
Arbeidsledighet er en vanlig indikatorene som benyttes for å vurdere regionale økonomiske tilstander.
Variablen sier noe om hvor god tilgang det er på arbeidsmuligheter i regionen.
Dersom en region har høy arbeidsledighet, er det mangel på økonokiske muligheter til befolkningen, som gir en økt inntektsulikhet.
Det forventes derfor at det er en positiv korelasjon mellom arbeidsledighet og ulikhet.

Befolkningstetthet måler hvor mange innbyggere en region har per kvadratkilometer.
Dette er en indikator på hvor urbane de ulike regionene er.
Områder med høy tetthet kan kalles for byområder, mens de med lav faller innenfor forstadene.
I mange land, for eksempel Norge er det typisk at industriend sentrer seg rundt byområder, hvor det er bedre tilgang på utdanning og et bredere spektrum av arbeidsmuligheter.

Utdanningsnivå måles som andelen av befolkningen som har en høyere utdanning.
I dette datasettet har vi filtrert og definert høyere utdanning ved koden ED5-8.
ED5-8 er altså tertiær utdanning, som omfatter Bachelorgrad (ED5), Mastergrad (ED7) og Doktorgrad (ED8).
Et høyt utdanningsnivå bidrar til økt produktivitet, innovasjon og høyere inntekstnivå, som kan redusere ulikhet gjennom bedre arbeidsmuligheter.
Samtidig kan forskjeller i utdanning mellom regioner føre til en økende ulikhet dersom utdanning og kompetanse i hovedsak er konsentrert i urbane eller økonomisk sterke områder.
Utdanning kan dermed føre til både muligheten for konvergens og risikoen for regional divergens.

```{r}
# Estimer lineær regresjon med oppdaterte variabelnavn
model_multi <- lm(gini ~ vekst + arbeidsledighet + bpk + hoyere_utdanning, data = Sammenstilt)

# Oppsummer modellen
summary_model <- summary(model_multi)

# Hent ut R2 og justert R2
r_squared <- summary_model$r.squared
adj_r_squared <- summary_model$adj.r.squared

# Hent ut F-statistikk og frihetsgrader
f_stat <- summary_model$fstatistic[1]
f_numdf <- summary_model$fstatistic[2]
f_dendf <- summary_model$fstatistic[3]

# Beregn p-verdien til F-statistikken
f_p_value <- pf(f_stat, f_numdf, f_dendf, lower.tail = FALSE)

# Skriv ut resultatene pent
cat("R-squared: ", format(round(r_squared, 4), nsmall = 4), "\n")
cat("Adjusted R-squared: ", format(round(adj_r_squared, 4), nsmall = 4), "\n")
cat("F-statistic: ", format(round(f_stat, 2), nsmall = 2), 
    " on ", f_numdf, " and ", f_dendf, " DF\n")
cat("Model p-value (F-test): ", format(signif(f_p_value, 4)), "\n")

```

Tabell 2 og 3 viser resultatene fra vår multippel regresjonsmodell hvorregional ulikhet (målt ved Gini-koeffisienten) forklares av økonomisk vekst (BNPPI_vekst), arbeidsledighet, befolkning (bpk) og høyere utdanning.

Konstantleddet (intercept) på 0.107 indikerer at den forventede Gini-verdien i en region er omtrent 0.107 når alle forklaringsvariabler er lik null.

Koeffisienten til **BNPPI_vekst** (0.0038) er positiv og svakt signifikant (p = 0.068), noe som indikerer at regioner med høyere økonomisk vekst har en tendens til å oppleve økt inntektsulikhet.
Dette kan tolkes som at gevinsten av økonomisk vekst i stor grad tilfaller bestemte deler av befolkningen, særlig de med høyere inntekt eller kapital, før fordelene på lengre sikt eventuelt fordeles jevnere.

**Arbeidsledighet** (-0.0024) har en negativ, men ikke-signifikant effekt (p = 0.184).
Dette kan tyde på at høyere arbeidsledighet isolert sett ikke er en sterk forklaringsfaktor i denne modellen, men retningen er som forventet – lavere sysselsetting øker normalt ulikhet.

Variabelen **bpk** (0.000022) viser en svært svak og statistisk ubetydelig sammenheng (p = 0.49), noe som indikerer at befolkningsstørrelse eller -tetthet i seg selv ikke forklarer mye av ulikhetsnivået mellom regionene.

Til slutt viser høyere utdanning (-0.0017) en negativ, men ikke-signifikant sammenheng med regional ulikhet (p = 0.114).
Dette tyder på at regioner med høyere utdanningsnivå i gjennomsnitt har lavere ulikhet, noe som er i tråd med teorien om at utdanning styrker humankapitalen og bidrar til sosial mobilitet.

**Modellens forklaringskraft**
R\^2 = 0.392 og justert R\^2 = 0.291 viser at modellen viser om lag 39% av variasjonen i regional ulikhet.
F-testen (p = 0.014) indikerer at modellen samlet sett er signifikant, selv om enkelte variabler ikke er det individuelt.
Dette betyr at forklaringsvariablene sammen bidrar til å forklare ulikhetsnivået på tvers av NUTS2-regionene.
Samlet sett antyder resultatene at økonomisk vekst og utdanningsnivå spiller de viktigste rollene i å forklare ulikhet, mens arbeidsledighet og befolkningstetthet har svakere eller mer indirekte effekter.

# Del C: Dokumentasjon for bruken av KI

Vi har benyttes oss av Chat-gpt5 og Chat-gpt3.
I denne oppgaven vi brukt KI til å først og fremst forstå og tolke hva oppgaven spør etter. Når vi har hatt knote feil med kode har vi benytt chat-gpt for å få hjelpende hånd i riktig retning. Vi har også brukt det til hjelp for å analysere dataeien og til å formulere teori delen på en bedre måte.
