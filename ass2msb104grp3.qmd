---
title: "Ass2MSB104GRP3"
format: pdf
editor: visual
bibliography: references.bib
---

```{r}
library(modelr)
library(dplyr)
library(ggplot2)
library(tidyverse)
library(vtable)
library(flextable)
library(scales)
library(tinytex)
library(readxl)
library(stringr)
library(janitor)
library(tidyr)
library(dineq) 
library(knitr)
library(ggrepel)
library(broom)
```

```{r}
Populasjon <- readRDS("data/Populasjon.rds")
BNP <- readRDS("data/BNP.rds")
```

## Modellestimering

```{r}
NUTS2_bnppi <- NUTS2_data %>%
  mutate(
    nuts2 = substr(geo, 1, 4),             # Henter ut de 4 første tegnene fra NUTS3-koden
    bnp = as.numeric(bnp),
    befolkning = as.numeric(befolkning)
  ) %>%
  group_by(nuts2, land, aar) %>%
  summarise(
    total_bnp = sum(bnp, na.rm = TRUE),       # Summer BNP (i millioner)
    total_befolkning = sum(befolkning, na.rm = TRUE)
  ) %>%
  mutate(
    bnppi = round((total_bnp * 1e6) / total_befolkning)  # BNP i hele kroner per innbygger
  ) %>%
  select(nuts2, land, aar, bnppi) %>%
  arrange(land, nuts2, aar)


```

```{r}

# Beregn GINI per NUTS2 og år
GINI_NUTS2 <- KombinertRen %>%
  group_by(nuts2, land, aar) %>%
  summarise(
    GINI_BNPPI = gini.wtd(BNPPI, weights = befolkning),
    .groups = "drop"
  ) %>%
  filter(!is.na(GINI_BNPPI) & GINI_BNPPI != 0) %>%
  arrange(land, nuts2, aar)
```

Her beregnes GINI på NUTS2 nivå utifra BNPPI på regionene på NUTS 3 nivå som tilhører de enkelte NUTS2 regionene.
Variablene som benyttes er BNP og befolkningstall på NUTS 3 region som beregner BNP per innbygger.
BNPPI på NUTS2 nivå beregnes ved å slå sammen alle NUTS3 regioner hvor de firste første tegnene i GEO koden er like.

```{r}

# Beregn vekst fra 2016 til 2017 på NUTS2 nivå
NUTS2_vekst <- NUTS2_bnppi %>%
  arrange(nuts2, aar) %>%
  group_by(nuts2, land) %>%
  mutate(
    BNPPI_vekst = (bnppi - lag(bnppi)) / lag(bnppi) * 100
  ) %>%
  filter(aar == 2017) %>%  # Kun 2017 som oppgaven spesifiserer
  select(nuts2, land, aar, BNPPI_vekst)

```

\
Her er det laget et nytt datasett, hvor den prosentvise endringen i BNPPI fra 2016 til 2017 beregnes.
Veksten blir beregnet ved å subtrahere BNPPI verdien i 2017 med 2016 verdien.
Ved å dele differansen på BNPPI verdien i 2016, kommer vi frem til vekstraten.
Formelen utfører denne beregningen på alle NUTS2 regionene.\

```{r}
# Kombiner vekst og ulikhet på NUTS2-nivå
Model_data_2017 <- GINI_NUTS2 %>%
  filter(aar == 2017) %>%
  left_join(NUTS2_vekst, by = c("nuts2", "land", "aar")) %>%
  filter(!is.na(BNPPI_vekst), !is.na(GINI_BNPPI))
```

I funksjonen over fremkommer analysegrunnlaget som skal brukes i regresjons modellen.
Vekst er sattt som uavhengi variabel, og GINI koefisienten som avhengi variabel.
Med dette datasettet kan vi teste @lessmann2017 sin teori om at det er en sammenheng mellom økonomisk vekst of ulikhet.

```{r}
# Lineær regresjon
model <- lm(GINI_BNPPI ~ BNPPI_vekst, data = Model_data_2017)

summary(model)
```

## Diagnose av modellen

## 

```{r tab:regresjon, echo=FALSE}

# Hent ut koeffisienter med broom::tidy
tidy_model <- broom::tidy(model)

# Lag signifikansstjerner basert på p-verdier
tidy_model <- tidy_model %>%
  mutate(
    Significance = case_when(
      p.value < 0.001 ~ "***",
      p.value < 0.01  ~ "**",
      p.value < 0.05  ~ "*",
      p.value < 0.1   ~ ".",
      TRUE            ~ ""
    )
  ) %>%
  rename(
    Variabel = term,
    Estimate = estimate,
    `Std. Error` = std.error,
    `t-verdi` = statistic,
    `p-verdi` = p.value
  ) %>%
  select(Variabel, Estimate, `Std. Error`, `t-verdi`, `p-verdi`, Significance)

# Presenter tabellen med kable
kable(
  tidy_model,
  digits = 4,
  caption = "Regresjonsresultater for modellen",
  col.names = c("Variabel", "Estimert koeffisient", "Standardfeil", "t-verdi", "p-verdi", "Signifikans")
)
```

Som det kommer frem i \@ref(tab:regresjon) er den forventede GINI verdien 0,0441 når vekst er lik null.
I dette datasettet kommer der frem at det er en positiv korelasjon mellom vekst og ulikhet.
ß1 har en forventing på 0,0053, som vil si at GINI koefisienten forventes å øke med denne verdien for hvert prosentpoeng BNPPI øker.

I @lessmann2017 sin tekst vil effekten man vil forvente å se på GINI koefisienten avhenge om regionen man ser på er rik eller fattig fra før.
I rikere land forventer man en negativ sammenheng mellom vekst og ulikhet, dvs at vekst fører til reduserte ulikheter mellom regioner.
Dette kommer av at i rikere land er vil i stor grad de rike regionene være såpass velstående at verdiøkningen ønskes sentrert i de områdene som er underuviklet sett i sammenheng med resten av landet.
I fattigere regioner forventer man på den andre siden å se en positiv sammenheng mellom vekst og ulikhet.
Dette kalles "kuznets" effekten.
Ettersom regresjonsanalysen ga en positiv ß1 verdi, burde det etter kuznets effekten indikere at datasettets inneholder mest regioner med lavere velstand relativt sett.

```{r}
# ... koden for "goodness-of-fit" tabellen ...

# Hent summary av modellen
mod_sum <- summary(model)

# Lag en dataframe med relevante mål
fit_stats <- tibble(
  Statistik = c(
    "R-squared",
    "Adjusted R-squared",
    "Residual Standard Error",
    "F-statistic",
    "F-statistic p-verdi"
  ),
  Verdi = c(
    round(mod_sum$r.squared, 4),
    round(mod_sum$adj.r.squared, 4),
    round(mod_sum$sigma, 4),
    round(mod_sum$fstatistic[1], 2),
    signif(pf(mod_sum$fstatistic[1], mod_sum$fstatistic[2], mod_sum$fstatistic[3], lower.tail = FALSE), 4)
  )
)

# Lag tabell med kable
kable(
  fit_stats,
  caption = "Goodness-of-fit statistikk for modellen",
  col.names = c("Statistikk", "Verdi")
)
```

I \@ref(tab:passelighet) presenteres statestikk som sier noe om hvor pålitlig regresjonsanalysen er.
R^2^ viser at omtrent 29,5% av variasjonen i ulikhet kan forklares av vekst i BNPPI.
Justert R^2^ tar høyde for hvor mange viarabler som er med i regresjonen, og gir en forklaringskraft på 26,8%.
Ettersom regresjonen bare har en variabel er ikke dette er overaskende resultat.

F statestikk er et mål som evaluerer om modeller har signifikant forklaringskraft.
Dersom den går mot 1 betyr det at modellen ikke er egnet til å forklare sammenhenger, jo større tallet blir jo sterkere validitet kan man gi til modellen.
P-verdien måler hvor pålitlig F statestikk verdien er.
I \@ref(tab:passelighet) har vi F statestikk målt til 11,3.
Et spåpass høyt tall vil si at modellen viser en sammenheng mellom de to variablene som ikke kan ansees som tilfelig.
I følge P verdigen er det en 0,23% sansynlighet for at variablene ikke har en sammenheng, som gir et sterkt grunnlag til å forkaste nullhypotese.

Samlet sett viser statestikken at modellen har validitet, men at det eksisterer ytterlige variabler som også påvirker utviklingen.

```{r}
ggplot(Model_data_2017, aes(x = BNPPI_vekst, y = GINI_BNPPI)) +
  geom_point(color = "blue", size = 3, alpha = 0.7) +                    # Punkter
  geom_smooth(method = "lm", se = TRUE, color = "red", linetype = "dashed") +  # Regresjonslinje med konfidensbånd
  labs(
    title = "Sammenheng mellom økonomisk vekst og regional ulikhet",
    subtitle = "Data fra NUTS2-regioner, år 2017",
    x = "BNP per innbygger, vekst (%) fra 2016 til 2017",
    y = "GINI-koeffisient for ulikhet",
    caption = "Scatterplot med regresjonslinje som viser sammenhengen mellom BNP-vekst og ulikhet i regioner."
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    plot.subtitle = element_text(size = 12),
    plot.caption = element_text(size = 10, face = "italic"),
    axis.title = element_text(size = 12)
  )
```

## Part B: Andre variabler som påvirker ulikhet

```{r}
# Henter inn Arbeidsledighet datasett fra excel
Arbeidsledighet <- read_excel("Arbeidsledighet.xlsx", sheet = 2, col_types = "text") %>%
  clean_names()
```

```{r}
# Henter inn Befolkningstetthet datasett fra excel
Befolkningstethet <- read_excel("Befolkningstethet.xlsx", sheet = 2, col_types = "text") %>%
  clean_names()

```

```{r}
# Henter inn Befolkningstetthet datasett fra excel
Hoyere_utdanning <- read_excel("Hoyere_utdanning.xlsx", sheet = 2, col_types = "text") %>%
  clean_names()

```

## Valg av variabler

Det er hentet inn 3 nye datasett som kan være med å forklare ulikhet mellom regioner.
Som det kom frem i del A gir modell \@ref(tab:passelighet) oss en forklaringskraft på ca 29%.
Det er derfor intressant å utvide modellen for å fange opp flere årsaker til ulikhet, samt å se hvor relavante andre variabler kan være.
Dataene som tilføyes er arbeidsledighet, og befolkningstethet.
Etter metadataene kommer det frem at det er populasjonen i alderen mellom 15 og 74 år som er tatt med i datasettet.

Arbeidsledighet er målt i prosent, og sier hvor stor andel av befolkningen innenfor NUTS2 regionene som er arbeidsledige.
Arbeidsledighet er en vanlig indikatorene som benyttes for å vurdere regionale økonomiske tilstander.
Variablen sier noe om hvor god tilgang det er på arbeidsmuligheter i regionen.
Dersom en region har høy arbeidsledighet, er det mangel på økonokiske muligheter til befolkningen, som gir en økt inntektsulikhet.
Det forventes derfor at det er en positiv korelasjon mellom arbeidsledighet og ulikhet.

Befolkningstetthet måler hvor mange innbyggere en region har per kvadratkilometer.
Dette er en indikator på hvor urbane de ulike regionene er.
Områder med høy tetthet kan kalles for byområder, mens de med lav faller innenfor forstadene.
I mange land, for eksempel Norge er det typisk at industriend sentrer seg rundt byområder, hvor det er bedre tilgang på utdanning og et bredere spektrum av arbeidsmuligheter.

```{r}
Sammenstilt <- Model_data_2017 %>%
  inner_join(Arbeidsledighet %>% select(nuts2, arbeidsledighet), by = "nuts2") %>%
  inner_join(Befolkningstethet %>% select(nuts2, bpk), by = "nuts2") %>%
  inner_join(Hoyere_utdanning %>% select(nuts2, hoyere_utdanning), by = "nuts2") %>%
  mutate(
    arbeidsledighet = as.numeric(str_replace_all(arbeidsledighet, ",", ".")),
    bpk = as.numeric(str_replace_all(bpk, ",", ".")),
    hoyere_utdanning = as.numeric(str_replace_all(hoyere_utdanning, ",", "."))
  ) %>%
  filter(!is.na(arbeidsledighet), !is.na(bpk), !is.na(hoyere_utdanning))


```
